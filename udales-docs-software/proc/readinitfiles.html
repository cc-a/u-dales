<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="TODO:">
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>readinitfiles &ndash; uDALES</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">uDALES </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/types.html">Derived Types</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/namelists.html">Namelists</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../program/dalesurban.html">Program</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>readinitfiles
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title=" 5.0% of total for procedures.">676 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/modstartup.f90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/modstartup.f90.html'>modstartup.f90</a></li>
                <li class="breadcrumb-item"><a href='../module/modstartup.html'>modstartup</a></li>
            <li class="breadcrumb-item active" aria-current="page">readinitfiles</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/readinitfiles.html#src">readinitfiles</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine readinitfiles()  
</h2>
        <div class="card mb-4">
      <h3 class="card-header card-title bg-light">Uses</h3>
      <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <ul class="list-inline">
                  <li class="list-inline-item"><a href='../module/moddriver.html'>moddriver</a></li>
                  <li class="list-inline-item"><a href='../module/modboundary.html'>modboundary</a></li>
                  <li class="list-inline-item"><a href='../module/modmpi.html'>modmpi</a></li>
                  <li class="list-inline-item"><a href='../module/modinlet.html'>modinlet</a></li>
                  <li class="list-inline-item"><a href='../module/modthermodynamics.html'>modthermodynamics</a></li>
                  <li class="list-inline-item"><a href='../module/modglobal.html'>modglobal</a></li>
                  <li class="list-inline-item"><a href='../module/modsubgriddata.html'>modsubgriddata</a></li>
                  <li class="list-inline-item"><a href='../module/modsurfdata.html'>modsurfdata</a></li>
                  <li class="list-inline-item"><a href='../module/modinletdata.html'>modinletdata</a></li>
                  <li class="list-inline-item">decomp_2d</li>
                  <li class="list-inline-item"><a href='../module/modfields.html'>modfields</a></li>
              </ul>
            </li>
            <li class="list-group-item">
              <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (0)
 -->
<!-- Title: proc~~readinitfiles~~UsesGraph Pages: 1 -->
<svg id="procreadinitfilesUsesGraph" width="366pt" height="444pt"
 viewBox="0.00 0.00 366.00 444.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~readinitfiles~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 440)">
<title>proc~~readinitfiles~~UsesGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-440 362,-440 362,4 -4,4"/>
<!-- proc~readinitfiles -->
<g id="proc~~readinitfiles~~UsesGraph_node1" class="node">
<title>proc~readinitfiles</title>
<polygon fill="none" stroke="black" points="358,-230 283,-230 283,-206 358,-206 358,-230"/>
<text text-anchor="middle" x="320.5" y="-215.6" font-family="Helvetica,sans-Serif" font-size="10.50">readinitfiles</text>
</g>
<!-- decomp_2d -->
<g id="proc~~readinitfiles~~UsesGraph_node2" class="node">
<title>decomp_2d</title>
<polygon fill="#337ab7" stroke="#337ab7" points="79.5,-416 4.5,-416 4.5,-392 79.5,-392 79.5,-416"/>
<text text-anchor="middle" x="42" y="-401.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">decomp_2d</text>
</g>
<!-- proc~readinitfiles&#45;&gt;decomp_2d -->
<g id="proc~~readinitfiles~~UsesGraph_edge1" class="edge">
<title>proc~readinitfiles&#45;&gt;decomp_2d</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M317.29,-230.21C311.43,-258.78 292.73,-330.18 247,-365 222.86,-383.38 142.31,-394.45 89.94,-399.87"/>
<polygon fill="#ff0000" stroke="#ff0000" points="89.47,-396.4 79.87,-400.89 90.16,-403.37 89.47,-396.4"/>
</g>
<!-- module~modboundary -->
<g id="proc~~readinitfiles~~UsesGraph_node3" class="node">
<title>module~modboundary</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node3"><a xlink:href="../module/modboundary.html" xlink:title="modboundary">
<polygon fill="#337ab7" stroke="#337ab7" points="227.5,-314 139.5,-314 139.5,-290 227.5,-290 227.5,-314"/>
<text text-anchor="middle" x="183.5" y="-299.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modboundary</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modboundary -->
<g id="proc~~readinitfiles~~UsesGraph_edge2" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modboundary</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M308.31,-230.28C294.94,-244.3 271.31,-267.09 247,-281 243.93,-282.76 240.68,-284.4 237.36,-285.92"/>
<polygon fill="#ff0000" stroke="#ff0000" points="235.7,-282.82 227.83,-289.92 238.4,-289.28 235.7,-282.82"/>
</g>
<!-- module~moddriver -->
<g id="proc~~readinitfiles~~UsesGraph_node4" class="node">
<title>module~moddriver</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node4"><a xlink:href="../module/moddriver.html" xlink:title="moddriver">
<polygon fill="#337ab7" stroke="#337ab7" points="217.5,-150 149.5,-150 149.5,-126 217.5,-126 217.5,-150"/>
<text text-anchor="middle" x="183.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">moddriver</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~moddriver -->
<g id="proc~~readinitfiles~~UsesGraph_edge3" class="edge">
<title>proc~readinitfiles&#45;&gt;module~moddriver</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M305.5,-205.93C291.4,-194.18 268.69,-176.34 247,-164 240.68,-160.4 233.76,-157.03 226.91,-153.98"/>
<polygon fill="#ff0000" stroke="#ff0000" points="228.23,-150.73 217.66,-150.02 225.48,-157.17 228.23,-150.73"/>
</g>
<!-- module~modfields -->
<g id="proc~~readinitfiles~~UsesGraph_node5" class="node">
<title>module~modfields</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node5"><a xlink:href="../module/modfields.html" xlink:title="modfields">
<polygon fill="#337ab7" stroke="#337ab7" points="216,-436 151,-436 151,-412 216,-412 216,-436"/>
<text text-anchor="middle" x="183.5" y="-421.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modfields</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modfields -->
<g id="proc~~readinitfiles~~UsesGraph_edge4" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modfields</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M317.87,-230.27C313.01,-262.17 295.79,-348.65 247,-398 241.07,-404 233.55,-408.68 225.79,-412.31"/>
<polygon fill="#ff0000" stroke="#ff0000" points="224.22,-409.17 216.31,-416.23 226.89,-415.64 224.22,-409.17"/>
</g>
<!-- module~modglobal -->
<g id="proc~~readinitfiles~~UsesGraph_node6" class="node">
<title>module~modglobal</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node6"><a xlink:href="../module/modglobal.html" xlink:title="modglobal">
<polygon fill="#337ab7" stroke="#337ab7" points="218.5,-272 148.5,-272 148.5,-248 218.5,-248 218.5,-272"/>
<text text-anchor="middle" x="183.5" y="-257.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modglobal</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modglobal -->
<g id="proc~~readinitfiles~~UsesGraph_edge5" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modglobal</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M282.97,-229.37C266.26,-234.56 246.31,-240.77 228.76,-246.23"/>
<polygon fill="#ff0000" stroke="#ff0000" points="227.25,-243.03 218.74,-249.35 229.33,-249.72 227.25,-243.03"/>
</g>
<!-- module~modinlet -->
<g id="proc~~readinitfiles~~UsesGraph_node7" class="node">
<title>module~modinlet</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node7"><a xlink:href="../module/modinlet.html" xlink:title="modinlet">
<polygon fill="#337ab7" stroke="#337ab7" points="213.5,-230 153.5,-230 153.5,-206 213.5,-206 213.5,-230"/>
<text text-anchor="middle" x="183.5" y="-215.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modinlet</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modinlet -->
<g id="proc~~readinitfiles~~UsesGraph_edge6" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modinlet</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M282.97,-218C264.74,-218 242.66,-218 224.03,-218"/>
<polygon fill="#ff0000" stroke="#ff0000" points="223.8,-214.5 213.8,-218 223.8,-221.5 223.8,-214.5"/>
</g>
<!-- module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_node8" class="node">
<title>module~modinletdata</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node8"><a xlink:href="../module/modinletdata.html" xlink:title="modinletdata">
<polygon fill="#337ab7" stroke="#337ab7" points="84,-190 0,-190 0,-166 84,-166 84,-190"/>
<text text-anchor="middle" x="42" y="-175.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modinletdata</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge7" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modinletdata</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M282.94,-205.95C271.54,-202.59 258.84,-199.25 247,-197 195.61,-187.26 135.96,-182.44 94.48,-180.1"/>
<polygon fill="#ff0000" stroke="#ff0000" points="94.52,-176.6 84.35,-179.56 94.15,-183.59 94.52,-176.6"/>
</g>
<!-- module~modmpi -->
<g id="proc~~readinitfiles~~UsesGraph_node9" class="node">
<title>module~modmpi</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node9"><a xlink:href="../module/modmpi.html" xlink:title="modmpi">
<polygon fill="#337ab7" stroke="#337ab7" points="212,-356 155,-356 155,-332 212,-332 212,-356"/>
<text text-anchor="middle" x="183.5" y="-341.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modmpi</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modmpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge8" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modmpi</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M314.23,-230.29C304.27,-252.11 280.63,-297.69 247,-323 239.62,-328.55 230.69,-332.69 221.92,-335.75"/>
<polygon fill="#ff0000" stroke="#ff0000" points="220.69,-332.47 212.17,-338.78 222.76,-339.16 220.69,-332.47"/>
</g>
<!-- module~modsubgriddata -->
<g id="proc~~readinitfiles~~UsesGraph_node10" class="node">
<title>module~modsubgriddata</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node10"><a xlink:href="../module/modsubgriddata.html" xlink:title="modsubgriddata">
<polygon fill="#337ab7" stroke="#337ab7" points="233.5,-108 133.5,-108 133.5,-84 233.5,-84 233.5,-108"/>
<text text-anchor="middle" x="183.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modsubgriddata</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modsubgriddata -->
<g id="proc~~readinitfiles~~UsesGraph_edge9" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modsubgriddata</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M313.94,-205.85C303.69,-184.74 279.81,-141.24 247,-117 244.91,-115.45 242.69,-114.01 240.39,-112.68"/>
<polygon fill="#ff0000" stroke="#ff0000" points="241.69,-109.41 231.19,-108.02 238.53,-115.66 241.69,-109.41"/>
</g>
<!-- module~modsurfdata -->
<g id="proc~~readinitfiles~~UsesGraph_node11" class="node">
<title>module~modsurfdata</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node11"><a xlink:href="../module/modsurfdata.html" xlink:title="modsurfdata">
<polygon fill="#337ab7" stroke="#337ab7" points="224,-66 143,-66 143,-42 224,-42 224,-66"/>
<text text-anchor="middle" x="183.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modsurfdata</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modsurfdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge10" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modsurfdata</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M316.66,-205.69C309.68,-178.21 289.11,-111.41 247,-75 243.04,-71.58 238.51,-68.71 233.72,-66.3"/>
<polygon fill="#ff0000" stroke="#ff0000" points="234.88,-62.99 224.31,-62.23 232.1,-69.41 234.88,-62.99"/>
</g>
<!-- module~modthermodynamics -->
<g id="proc~~readinitfiles~~UsesGraph_node12" class="node">
<title>module~modthermodynamics</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node12"><a xlink:href="../module/modthermodynamics.html" xlink:title="modthermodynamics">
<polygon fill="#337ab7" stroke="#337ab7" points="247,-24 120,-24 120,0 247,0 247,-24"/>
<text text-anchor="middle" x="183.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modthermodynamics</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modthermodynamics -->
<g id="proc~~readinitfiles~~UsesGraph_edge11" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modthermodynamics</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M318.23,-205.67C314.2,-172.8 298.72,-82.23 247,-33 245.72,-31.78 244.36,-30.63 242.95,-29.55"/>
<polygon fill="#ff0000" stroke="#ff0000" points="244.6,-26.45 234.28,-24.04 240.85,-32.36 244.6,-26.45"/>
</g>
<!-- mpi -->
<g id="proc~~readinitfiles~~UsesGraph_node13" class="node">
<title>mpi</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node13"><a xlink:href="http://www.mpi-forum.org/docs/mpi-3.1/mpi31-report/node410.htm" xlink:title="mpi">
<polygon fill="#337ab7" stroke="#337ab7" points="69,-314 15,-314 15,-290 69,-290 69,-314"/>
<text text-anchor="middle" x="42" y="-299.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi</text>
</a>
</g>
</g>
<!-- module~modboundary&#45;&gt;mpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge12" class="edge">
<title>module~modboundary&#45;&gt;mpi</title>
<path fill="none" stroke="#ff8b00" stroke-dasharray="5,2" d="M139.13,-302C120,-302 97.78,-302 79.52,-302"/>
<polygon fill="#ff8b00" stroke="#ff8b00" points="79.28,-298.5 69.28,-302 79.28,-305.5 79.28,-298.5"/>
</g>
<!-- module~moddriver&#45;&gt;module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge13" class="edge">
<title>module~moddriver&#45;&gt;module~modinletdata</title>
<path fill="none" stroke="#e7ff00" stroke-dasharray="5,2" d="M149.44,-147.48C132.84,-152.24 112.37,-158.11 93.83,-163.42"/>
<polygon fill="#e7ff00" stroke="#e7ff00" points="92.71,-160.11 84.06,-166.23 94.63,-166.84 92.71,-160.11"/>
</g>
<!-- module~modfields&#45;&gt;decomp_2d -->
<g id="proc~~readinitfiles~~UsesGraph_edge14" class="edge">
<title>module~modfields&#45;&gt;decomp_2d</title>
<path fill="none" stroke="#5cff00" stroke-dasharray="5,2" d="M150.85,-419.46C132.76,-416.87 109.74,-413.57 89.62,-410.68"/>
<polygon fill="#5cff00" stroke="#5cff00" points="90.11,-407.22 79.71,-409.26 89.11,-414.15 90.11,-407.22"/>
</g>
<!-- module~modinlet&#45;&gt;module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge15" class="edge">
<title>module~modinlet&#45;&gt;module~modinletdata</title>
<path fill="none" stroke="#00ffb9" stroke-dasharray="5,2" d="M153.26,-209.61C136.02,-204.67 113.74,-198.28 93.72,-192.54"/>
<polygon fill="#00ffb9" stroke="#00ffb9" points="94.69,-189.18 84.11,-189.79 92.76,-195.91 94.69,-189.18"/>
</g>
<!-- module~modinlet&#45;&gt;mpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge16" class="edge">
<title>module~modinlet&#45;&gt;mpi</title>
<path fill="none" stroke="#00ffb9" stroke-dasharray="5,2" d="M153.27,-225.43C142.45,-228.78 130.32,-233.3 120,-239 98.57,-250.84 77.27,-268.89 62.52,-282.63"/>
<polygon fill="#00ffb9" stroke="#00ffb9" points="59.86,-280.33 55.04,-289.76 64.69,-285.4 59.86,-280.33"/>
</g>
<!-- module~modmpi&#45;&gt;mpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge17" class="edge">
<title>module~modmpi&#45;&gt;mpi</title>
<path fill="none" stroke="#002eff" stroke-dasharray="5,2" d="M154.94,-335.7C133.12,-329.13 102.49,-319.91 78.78,-312.77"/>
<polygon fill="#002eff" stroke="#002eff" points="79.67,-309.39 69.09,-309.85 77.65,-316.09 79.67,-309.39"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#UsesGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="UsesGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="518pt" height="32pt"
 viewBox="0.00 0.00 517.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 513.5,-28 513.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node">
<title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,0 54,0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node">
<title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="145.5,-24 72.5,-24 72.5,0 145.5,0 145.5,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="234,-24 164,-24 164,0 234,0 234,-24"/>
<text text-anchor="middle" x="199" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="310,-24 252,-24 252,0 310,0 310,-24"/>
<text text-anchor="middle" x="281" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="386,-24 328,-24 328,0 386,0 386,-24"/>
<text text-anchor="middle" x="357" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="509.5,-24 404.5,-24 404.5,0 509.5,0 509.5,-24"/>
<text text-anchor="middle" x="457" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a submodule to the (sub)module which it is
descended from. Dashed arrows point from a module or program unit to 
modules which it uses.
</p>
 Where possible, edges connecting nodes are
given different colours to make them easier to distinguish in
large graphs.</div>
            </div>
          </div>
        </div>
            </li>
        </ul>
      </div>
    </div>




    <h3>Arguments</h3>
    <em>None</em>
    <br>
    <br>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Calls</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (0)
 -->
<!-- Title: proc~~readinitfiles~~CallsGraph Pages: 1 -->
<svg id="procreadinitfilesCallsGraph" width="609pt" height="1112pt"
 viewBox="0.00 0.00 609.00 1112.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~readinitfiles~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1108)">
<title>proc~~readinitfiles~~CallsGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-1108 605,-1108 605,4 -4,4"/>
<!-- proc~readinitfiles -->
<g id="proc~~readinitfiles~~CallsGraph_node1" class="node">
<title>proc~readinitfiles</title>
<polygon fill="none" stroke="black" points="75,-717 0,-717 0,-693 75,-693 75,-717"/>
<text text-anchor="middle" x="37.5" y="-702.6" font-family="Helvetica,sans-Serif" font-size="10.50">readinitfiles</text>
</g>
<!-- mpi_bcast -->
<g id="proc~~readinitfiles~~CallsGraph_node2" class="node">
<title>mpi_bcast</title>
<polygon fill="#777777" stroke="#777777" points="205.5,-1104 138.5,-1104 138.5,-1080 205.5,-1080 205.5,-1104"/>
<text text-anchor="middle" x="172" y="-1089.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_bcast</text>
</g>
<!-- proc~readinitfiles&#45;&gt;mpi_bcast -->
<g id="proc~~readinitfiles~~CallsGraph_edge1" class="edge">
<title>proc~readinitfiles&#45;&gt;mpi_bcast</title>
<path fill="none" stroke="#ff0000" d="M39.44,-717.14C44.04,-773.59 65.78,-1010.08 111,-1066 115.76,-1071.89 122.11,-1076.47 128.9,-1080.03"/>
<polygon fill="#ff0000" stroke="#ff0000" points="127.77,-1083.36 138.33,-1084.28 130.65,-1076.98 127.77,-1083.36"/>
</g>
<!-- proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_node3" class="node">
<title>proc~avexy_ibm</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node3"><a xlink:href="../proc/avexy_ibm.html" xlink:title="avexy_ibm">
<polygon fill="#d9534f" stroke="#d9534f" points="477,-1005 408,-1005 408,-981 477,-981 477,-1005"/>
<text text-anchor="middle" x="442.5" y="-990.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">avexy_ibm</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_edge2" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~avexy_ibm</title>
<path fill="none" stroke="#ff0000" d="M40.26,-717.04C45.5,-749.26 63.73,-838.7 111,-894 163.65,-955.6 191.22,-962.26 269,-985 311.56,-997.44 362.52,-998.18 397.97,-996.58"/>
<polygon fill="#ff0000" stroke="#ff0000" points="398.19,-1000.07 407.99,-996.05 397.82,-993.08 398.19,-1000.07"/>
</g>
<!-- proc~calc_halflev -->
<g id="proc~~readinitfiles~~CallsGraph_node4" class="node">
<title>proc~calc_halflev</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node4"><a xlink:href="../proc/calc_halflev.html" xlink:title="calc_halflev">
<polygon fill="#d9534f" stroke="#d9534f" points="358.5,-822 282.5,-822 282.5,-798 358.5,-798 358.5,-822"/>
<text text-anchor="middle" x="320.5" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">calc_halflev</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~calc_halflev -->
<g id="proc~~readinitfiles~~CallsGraph_edge3" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~calc_halflev</title>
<path fill="none" stroke="#ff0000" d="M51.65,-717.08C65.45,-729.14 88.27,-747.36 111,-758 163.39,-782.53 228.82,-796.42 272.26,-803.56"/>
<polygon fill="#ff0000" stroke="#ff0000" points="271.84,-807.04 282.27,-805.15 272.94,-800.13 271.84,-807.04"/>
</g>
<!-- proc~drivergen -->
<g id="proc~~readinitfiles~~CallsGraph_node5" class="node">
<title>proc~drivergen</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node5"><a xlink:href="../proc/drivergen.html" xlink:title="drivergen">
<polygon fill="#d9534f" stroke="#d9534f" points="204,-749 140,-749 140,-725 204,-725 204,-749"/>
<text text-anchor="middle" x="172" y="-734.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">drivergen</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~drivergen -->
<g id="proc~~readinitfiles~~CallsGraph_edge4" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~drivergen</title>
<path fill="none" stroke="#ff0000" d="M75.06,-713.83C92.09,-717.94 112.42,-722.85 129.98,-727.09"/>
<polygon fill="#ff0000" stroke="#ff0000" points="129.41,-730.56 139.95,-729.5 131.05,-723.75 129.41,-730.56"/>
</g>
<!-- proc~halos -->
<g id="proc~~readinitfiles~~CallsGraph_node6" class="node">
<title>proc~halos</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node6"><a xlink:href="../proc/halos.html" xlink:title="halos">
<polygon fill="#d9534f" stroke="#d9534f" points="199,-654 145,-654 145,-630 199,-630 199,-654"/>
<text text-anchor="middle" x="172" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">halos</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~halos -->
<g id="proc~~readinitfiles~~CallsGraph_edge5" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~halos</title>
<path fill="none" stroke="#ff0000" d="M64.05,-692.85C84.58,-683.09 113.62,-669.28 136.26,-658.52"/>
<polygon fill="#ff0000" stroke="#ff0000" points="138,-661.56 145.53,-654.11 135,-655.24 138,-661.56"/>
</g>
<!-- proc~randomnize -->
<g id="proc~~readinitfiles~~CallsGraph_node7" class="node">
<title>proc~randomnize</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node7"><a xlink:href="../proc/randomnize.html" xlink:title="randomnize">
<polygon fill="#d9534f" stroke="#d9534f" points="210,-612 134,-612 134,-588 210,-588 210,-612"/>
<text text-anchor="middle" x="172" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">randomnize</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~randomnize -->
<g id="proc~~readinitfiles~~CallsGraph_edge6" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~randomnize</title>
<path fill="none" stroke="#ff0000" d="M45.91,-692.95C57.6,-674.86 82.02,-640.73 111,-621 115.06,-618.23 119.53,-615.8 124.13,-613.65"/>
<polygon fill="#ff0000" stroke="#ff0000" points="125.81,-616.74 133.69,-609.66 123.12,-610.28 125.81,-616.74"/>
</g>
<!-- proc~readdriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_node8" class="node">
<title>proc~readdriverfile</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node8"><a xlink:href="../proc/readdriverfile.html" xlink:title="readdriverfile">
<polygon fill="#d9534f" stroke="#d9534f" points="214.5,-570 129.5,-570 129.5,-546 214.5,-546 214.5,-570"/>
<text text-anchor="middle" x="172" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readdriverfile</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readdriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_edge7" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readdriverfile</title>
<path fill="none" stroke="#ff0000" d="M42.31,-692.69C50.66,-667.67 72.93,-610.59 111,-579 113.84,-576.64 116.97,-574.54 120.25,-572.67"/>
<polygon fill="#ff0000" stroke="#ff0000" points="121.82,-575.8 129.24,-568.24 118.72,-569.52 121.82,-575.8"/>
</g>
<!-- proc~readdriverfile_chunk -->
<g id="proc~~readinitfiles~~CallsGraph_node9" class="node">
<title>proc~readdriverfile_chunk</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node9"><a xlink:href="../proc/readdriverfile_chunk.html" xlink:title="readdriverfile_chunk">
<polygon fill="#d9534f" stroke="#d9534f" points="233,-528 111,-528 111,-504 233,-504 233,-528"/>
<text text-anchor="middle" x="172" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readdriverfile_chunk</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readdriverfile_chunk -->
<g id="proc~~readinitfiles~~CallsGraph_edge8" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readdriverfile_chunk</title>
<path fill="none" stroke="#ff0000" d="M40.31,-692.94C45.52,-662.42 63.35,-581.39 111,-537 112.3,-535.78 113.68,-534.64 115.12,-533.56"/>
<polygon fill="#ff0000" stroke="#ff0000" points="117.29,-536.33 123.91,-528.07 113.58,-530.4 117.29,-536.33"/>
</g>
<!-- proc~readinletfile -->
<g id="proc~~readinitfiles~~CallsGraph_node10" class="node">
<title>proc~readinletfile</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node10"><a xlink:href="../proc/readinletfile.html" xlink:title="readinletfile">
<polygon fill="#d9534f" stroke="#d9534f" points="210,-297 134,-297 134,-273 210,-273 210,-297"/>
<text text-anchor="middle" x="172" y="-282.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readinletfile</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readinletfile -->
<g id="proc~~readinitfiles~~CallsGraph_edge9" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readinletfile</title>
<path fill="none" stroke="#ff0000" d="M42.32,-692.88C60.68,-634.68 139.92,-383.51 164.02,-307.12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="167.49,-307.76 167.16,-297.17 160.82,-305.65 167.49,-307.76"/>
</g>
<!-- proc~readrestartfiles -->
<g id="proc~~readinitfiles~~CallsGraph_node11" class="node">
<title>proc~readrestartfiles</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node11"><a xlink:href="../proc/readrestartfiles.html" xlink:title="readrestartfiles">
<polygon fill="#d9534f" stroke="#d9534f" points="218.5,-108 125.5,-108 125.5,-84 218.5,-84 218.5,-108"/>
<text text-anchor="middle" x="172" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readrestartfiles</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readrestartfiles -->
<g id="proc~~readinitfiles~~CallsGraph_edge10" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readrestartfiles</title>
<path fill="none" stroke="#ff0000" d="M39.68,-692.91C44.92,-640.88 67.79,-431.14 111,-264 124.86,-210.39 148.63,-149.72 161.7,-118"/>
<polygon fill="#ff0000" stroke="#ff0000" points="165.08,-118.98 165.7,-108.4 158.62,-116.29 165.08,-118.98"/>
</g>
<!-- proc~slabsum -->
<g id="proc~~readinitfiles~~CallsGraph_node12" class="node">
<title>proc~slabsum</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node12"><a xlink:href="../proc/slabsum.html" xlink:title="slabsum">
<polygon fill="#d9534f" stroke="#d9534f" points="471,-1055 414,-1055 414,-1031 471,-1031 471,-1055"/>
<text text-anchor="middle" x="442.5" y="-1040.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">slabsum</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~slabsum -->
<g id="proc~~readinitfiles~~CallsGraph_edge11" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~slabsum</title>
<path fill="none" stroke="#ff0000" d="M38.53,-717.16C39.27,-756.04 46.83,-878.81 111,-947 189.12,-1030.02 334.38,-1042.62 403.3,-1043.65"/>
<polygon fill="#ff0000" stroke="#ff0000" points="403.66,-1047.15 413.69,-1043.72 403.71,-1040.15 403.66,-1047.15"/>
</g>
<!-- proc~thermodynamics -->
<g id="proc~~readinitfiles~~CallsGraph_node13" class="node">
<title>proc~thermodynamics</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node13"><a xlink:href="../proc/thermodynamics.html" xlink:title="thermodynamics">
<polygon fill="#d9534f" stroke="#d9534f" points="223.5,-885 120.5,-885 120.5,-861 223.5,-861 223.5,-885"/>
<text text-anchor="middle" x="172" y="-870.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">thermodynamics</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~thermodynamics -->
<g id="proc~~readinitfiles~~CallsGraph_edge12" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~thermodynamics</title>
<path fill="none" stroke="#ff0000" d="M44.34,-717.24C55.38,-739.68 80.94,-788.28 111,-823 121.11,-834.68 134.11,-845.87 145.42,-854.69"/>
<polygon fill="#ff0000" stroke="#ff0000" points="143.58,-857.69 153.67,-860.94 147.81,-852.11 143.58,-857.69"/>
</g>
<!-- mpi_allreduce -->
<g id="proc~~readinitfiles~~CallsGraph_node15" class="node">
<title>mpi_allreduce</title>
<polygon fill="#777777" stroke="#777777" points="601,-1030 513,-1030 513,-1006 601,-1006 601,-1030"/>
<text text-anchor="middle" x="557" y="-1015.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_allreduce</text>
</g>
<!-- proc~avexy_ibm&#45;&gt;mpi_allreduce -->
<g id="proc~~readinitfiles~~CallsGraph_edge13" class="edge">
<title>proc~avexy_ibm&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#ff7f00" d="M477.25,-1000.5C485.34,-1002.3 494.17,-1004.26 502.9,-1006.2"/>
<polygon fill="#ff7f00" stroke="#ff7f00" points="502.15,-1009.62 512.67,-1008.37 503.67,-1002.79 502.15,-1009.62"/>
</g>
<!-- proc~writedriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_node20" class="node">
<title>proc~writedriverfile</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node20"><a xlink:href="../proc/writedriverfile.html" xlink:title="writedriverfile">
<polygon fill="#d9534f" stroke="#d9534f" points="364,-780 277,-780 277,-756 364,-756 364,-780"/>
<text text-anchor="middle" x="320.5" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">writedriverfile</text>
</a>
</g>
</g>
<!-- proc~drivergen&#45;&gt;proc~writedriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_edge14" class="edge">
<title>proc~drivergen&#45;&gt;proc~writedriverfile</title>
<path fill="none" stroke="#7fff00" d="M204.07,-743.57C222.34,-747.44 245.93,-752.43 267.01,-756.89"/>
<polygon fill="#7fff00" stroke="#7fff00" points="266.3,-760.32 276.81,-758.97 267.75,-753.47 266.3,-760.32"/>
</g>
<!-- exchange_halo_z -->
<g id="proc~~readinitfiles~~CallsGraph_node14" class="node">
<title>exchange_halo_z</title>
<polygon fill="#777777" stroke="#777777" points="372,-402 269,-402 269,-378 372,-378 372,-402"/>
<text text-anchor="middle" x="320.5" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">exchange_halo_z</text>
</g>
<!-- proc~halos&#45;&gt;exchange_halo_z -->
<g id="proc~~readinitfiles~~CallsGraph_edge15" class="edge">
<title>proc~halos&#45;&gt;exchange_halo_z</title>
<path fill="none" stroke="#00ff00" d="M199.18,-638.94C211.19,-636.18 224.59,-630.94 233,-621 294.15,-548.69 209.96,-485.03 269,-411 269.71,-410.11 270.47,-409.26 271.26,-408.44"/>
<polygon fill="#00ff00" stroke="#00ff00" points="273.67,-410.99 279.29,-402.01 269.3,-405.53 273.67,-410.99"/>
</g>
<!-- proc~xm_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node21" class="node">
<title>proc~xm_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node21"><a xlink:href="../proc/xm_periodic.html" xlink:title="xm_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="359.5,-738 281.5,-738 281.5,-714 359.5,-714 359.5,-738"/>
<text text-anchor="middle" x="320.5" y="-723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xm_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xm_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge16" class="edge">
<title>proc~halos&#45;&gt;proc~xm_periodic</title>
<path fill="none" stroke="#00ff00" d="M189.41,-654.14C208.08,-667.61 239.76,-689.5 269,-705 272.07,-706.63 275.3,-708.22 278.57,-709.75"/>
<polygon fill="#00ff00" stroke="#00ff00" points="277.27,-713.01 287.83,-713.9 280.13,-706.62 277.27,-713.01"/>
</g>
<!-- proc~xq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node22" class="node">
<title>proc~xq_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node22"><a xlink:href="../proc/xq_periodic.html" xlink:title="xq_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="357.5,-696 283.5,-696 283.5,-672 357.5,-672 357.5,-696"/>
<text text-anchor="middle" x="320.5" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xq_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge17" class="edge">
<title>proc~halos&#45;&gt;proc~xq_periodic</title>
<path fill="none" stroke="#00ff00" d="M199.19,-649.51C219.81,-655.42 249.05,-663.8 273.54,-670.82"/>
<polygon fill="#00ff00" stroke="#00ff00" points="272.78,-674.25 283.36,-673.64 274.71,-667.52 272.78,-674.25"/>
</g>
<!-- proc~xs_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node23" class="node">
<title>proc~xs_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node23"><a xlink:href="../proc/xs_periodic.html" xlink:title="xs_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="357,-654 284,-654 284,-630 357,-630 357,-654"/>
<text text-anchor="middle" x="320.5" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xs_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xs_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge18" class="edge">
<title>proc~halos&#45;&gt;proc~xs_periodic</title>
<path fill="none" stroke="#00ff00" d="M199.19,-642C219.86,-642 249.2,-642 273.72,-642"/>
<polygon fill="#00ff00" stroke="#00ff00" points="273.9,-645.5 283.9,-642 273.9,-638.5 273.9,-645.5"/>
</g>
<!-- proc~xt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node24" class="node">
<title>proc~xt_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node24"><a xlink:href="../proc/xt_periodic.html" xlink:title="xT_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="357.5,-612 283.5,-612 283.5,-588 357.5,-588 357.5,-612"/>
<text text-anchor="middle" x="320.5" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xT_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge19" class="edge">
<title>proc~halos&#45;&gt;proc~xt_periodic</title>
<path fill="none" stroke="#00ff00" d="M199.19,-634.49C219.81,-628.58 249.05,-620.2 273.54,-613.18"/>
<polygon fill="#00ff00" stroke="#00ff00" points="274.71,-616.48 283.36,-610.36 272.78,-609.75 274.71,-616.48"/>
</g>
<!-- proc~ym_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node26" class="node">
<title>proc~ym_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node26"><a xlink:href="../proc/ym_periodic.html" xlink:title="ym_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="359.5,-570 281.5,-570 281.5,-546 359.5,-546 359.5,-570"/>
<text text-anchor="middle" x="320.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ym_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~ym_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge20" class="edge">
<title>proc~halos&#45;&gt;proc~ym_periodic</title>
<path fill="none" stroke="#00ff00" d="M199.21,-636.07C210.26,-632.78 222.89,-627.91 233,-621 253.3,-607.13 249.11,-593.45 269,-579 271.05,-577.51 273.22,-576.1 275.47,-574.78"/>
<polygon fill="#00ff00" stroke="#00ff00" points="277.18,-577.83 284.39,-570.07 273.92,-571.64 277.18,-577.83"/>
</g>
<!-- proc~yq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node27" class="node">
<title>proc~yq_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node27"><a xlink:href="../proc/yq_periodic.html" xlink:title="yq_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="357.5,-528 283.5,-528 283.5,-504 357.5,-504 357.5,-528"/>
<text text-anchor="middle" x="320.5" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">yq_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~yq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge21" class="edge">
<title>proc~halos&#45;&gt;proc~yq_periodic</title>
<path fill="none" stroke="#00ff00" d="M199.11,-637.79C210.67,-634.78 223.72,-629.66 233,-621 262.68,-593.28 240.12,-565.57 269,-537 270.67,-535.35 272.49,-533.81 274.42,-532.4"/>
<polygon fill="#00ff00" stroke="#00ff00" points="276.7,-535.11 283.4,-526.9 273.05,-529.14 276.7,-535.11"/>
</g>
<!-- proc~ys_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node28" class="node">
<title>proc~ys_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node28"><a xlink:href="../proc/ys_periodic.html" xlink:title="ys_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="357,-486 284,-486 284,-462 357,-462 357,-486"/>
<text text-anchor="middle" x="320.5" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ys_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~ys_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge22" class="edge">
<title>proc~halos&#45;&gt;proc~ys_periodic</title>
<path fill="none" stroke="#00ff00" d="M199.02,-638.46C210.85,-635.59 224.14,-630.39 233,-621 272.96,-578.63 230.27,-538.5 269,-495 270.8,-492.98 272.82,-491.16 274.99,-489.5"/>
<polygon fill="#00ff00" stroke="#00ff00" points="277.32,-492.17 283.97,-483.93 273.63,-486.23 277.32,-492.17"/>
</g>
<!-- proc~yt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node29" class="node">
<title>proc~yt_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node29"><a xlink:href="../proc/yt_periodic.html" xlink:title="yT_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="357.5,-444 283.5,-444 283.5,-420 357.5,-420 357.5,-444"/>
<text text-anchor="middle" x="320.5" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">yT_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~yt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge23" class="edge">
<title>proc~halos&#45;&gt;proc~yt_periodic</title>
<path fill="none" stroke="#00ff00" d="M199,-638.79C210.97,-635.99 224.39,-630.77 233,-621 283.5,-563.72 220.16,-511.7 269,-453 270.7,-450.96 272.63,-449.11 274.73,-447.44"/>
<polygon fill="#00ff00" stroke="#00ff00" points="276.93,-450.18 283.45,-441.84 273.14,-444.29 276.93,-450.18"/>
</g>
<!-- proc~excjs -->
<g id="proc~~readinitfiles~~CallsGraph_node18" class="node">
<title>proc~excjs</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node18"><a xlink:href="../proc/excjs.html" xlink:title="excjs">
<polygon fill="#d9534f" stroke="#d9534f" points="347.5,-318 293.5,-318 293.5,-294 347.5,-294 347.5,-318"/>
<text text-anchor="middle" x="320.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">excjs</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~excjs -->
<g id="proc~~readinitfiles~~CallsGraph_edge24" class="edge">
<title>proc~readinletfile&#45;&gt;proc~excjs</title>
<path fill="none" stroke="#0000ff" d="M210.35,-290.35C232.74,-293.56 261.08,-297.63 283.27,-300.81"/>
<polygon fill="#0000ff" stroke="#0000ff" points="282.91,-304.29 293.31,-302.25 283.91,-297.36 282.91,-304.29"/>
</g>
<!-- proc~yinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_node25" class="node">
<title>proc~yinterpolate</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node25"><a xlink:href="../proc/yinterpolate.html" xlink:title="yinterpolate">
<polygon fill="#d9534f" stroke="#d9534f" points="359,-276 282,-276 282,-252 359,-252 359,-276"/>
<text text-anchor="middle" x="320.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">yinterpolate</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~yinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_edge25" class="edge">
<title>proc~readinletfile&#45;&gt;proc~yinterpolate</title>
<path fill="none" stroke="#0000ff" d="M210.35,-279.65C229.04,-276.97 251.89,-273.69 271.84,-270.83"/>
<polygon fill="#0000ff" stroke="#0000ff" points="272.56,-274.26 281.97,-269.38 271.57,-267.33 272.56,-274.26"/>
</g>
<!-- proc~zinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_node30" class="node">
<title>proc~zinterpolate</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node30"><a xlink:href="../proc/zinterpolate.html" xlink:title="zinterpolate">
<polygon fill="#d9534f" stroke="#d9534f" points="358.5,-234 282.5,-234 282.5,-210 358.5,-210 358.5,-234"/>
<text text-anchor="middle" x="320.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolate</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~zinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_edge26" class="edge">
<title>proc~readinletfile&#45;&gt;proc~zinterpolate</title>
<path fill="none" stroke="#0000ff" d="M200.25,-272.92C219.44,-264.45 245.74,-252.92 269,-243 272.88,-241.34 276.94,-239.63 280.99,-237.93"/>
<polygon fill="#0000ff" stroke="#0000ff" points="282.48,-241.1 290.35,-234.01 279.78,-234.64 282.48,-241.1"/>
</g>
<!-- proc~zinterpolatet -->
<g id="proc~~readinitfiles~~CallsGraph_node33" class="node">
<title>proc~zinterpolatet</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node33"><a xlink:href="../proc/zinterpolatet.html" xlink:title="zinterpolatet">
<polygon fill="#d9534f" stroke="#d9534f" points="360.5,-192 280.5,-192 280.5,-168 360.5,-168 360.5,-192"/>
<text text-anchor="middle" x="320.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatet</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~zinterpolatet -->
<g id="proc~~readinitfiles~~CallsGraph_edge27" class="edge">
<title>proc~readinletfile&#45;&gt;proc~zinterpolatet</title>
<path fill="none" stroke="#0000ff" d="M184.41,-272.75C201.44,-255.03 235.15,-222.05 269,-201 271.58,-199.4 274.3,-197.87 277.09,-196.42"/>
<polygon fill="#0000ff" stroke="#0000ff" points="278.64,-199.55 286.13,-192.06 275.6,-193.25 278.64,-199.55"/>
</g>
<!-- proc~zinterpolatew -->
<g id="proc~~readinitfiles~~CallsGraph_node35" class="node">
<title>proc~zinterpolatew</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node35"><a xlink:href="../proc/zinterpolatew.html" xlink:title="zinterpolatew">
<polygon fill="#d9534f" stroke="#d9534f" points="363,-360 278,-360 278,-336 363,-336 363,-360"/>
<text text-anchor="middle" x="320.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatew</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~zinterpolatew -->
<g id="proc~~readinitfiles~~CallsGraph_edge28" class="edge">
<title>proc~readinletfile&#45;&gt;proc~zinterpolatew</title>
<path fill="none" stroke="#0000ff" d="M200.25,-297.08C219.44,-305.55 245.74,-317.08 269,-327 272.88,-328.66 276.94,-330.37 280.99,-332.07"/>
<polygon fill="#0000ff" stroke="#0000ff" points="279.78,-335.36 290.35,-335.99 282.48,-328.9 279.78,-335.36"/>
</g>
<!-- proc~zinterpolate1d -->
<g id="proc~~readinitfiles~~CallsGraph_node31" class="node">
<title>proc~zinterpolate1d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node31"><a xlink:href="../proc/zinterpolate1d.html" xlink:title="zinterpolate1d">
<polygon fill="#d9534f" stroke="#d9534f" points="365.5,-66 275.5,-66 275.5,-42 365.5,-42 365.5,-66"/>
<text text-anchor="middle" x="320.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolate1d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolate1d -->
<g id="proc~~readinitfiles~~CallsGraph_edge29" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolate1d</title>
<path fill="none" stroke="#7f00ff" d="M214.98,-83.96C231.38,-79.26 250.35,-73.82 267.59,-68.88"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="268.86,-72.16 277.51,-66.04 266.94,-65.43 268.86,-72.16"/>
</g>
<!-- proc~zinterpolate2d -->
<g id="proc~~readinitfiles~~CallsGraph_node32" class="node">
<title>proc~zinterpolate2d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node32"><a xlink:href="../proc/zinterpolate2d.html" xlink:title="zinterpolate2d">
<polygon fill="#d9534f" stroke="#d9534f" points="365.5,-24 275.5,-24 275.5,0 365.5,0 365.5,-24"/>
<text text-anchor="middle" x="320.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolate2d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolate2d -->
<g id="proc~~readinitfiles~~CallsGraph_edge30" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolate2d</title>
<path fill="none" stroke="#7f00ff" d="M189.41,-83.86C208.08,-70.39 239.76,-48.5 269,-33 272.07,-31.37 275.3,-29.78 278.57,-28.25"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="280.13,-31.38 287.83,-24.1 277.27,-24.99 280.13,-31.38"/>
</g>
<!-- proc~zinterpolatet1d -->
<g id="proc~~readinitfiles~~CallsGraph_node34" class="node">
<title>proc~zinterpolatet1d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node34"><a xlink:href="../proc/zinterpolatet1d.html" xlink:title="zinterpolatet1d">
<polygon fill="#d9534f" stroke="#d9534f" points="367.5,-150 273.5,-150 273.5,-126 367.5,-126 367.5,-150"/>
<text text-anchor="middle" x="320.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatet1d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolatet1d -->
<g id="proc~~readinitfiles~~CallsGraph_edge31" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolatet1d</title>
<path fill="none" stroke="#7f00ff" d="M214.98,-108.04C231.38,-112.74 250.35,-118.18 267.59,-123.12"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="266.94,-126.57 277.51,-125.96 268.86,-119.84 266.94,-126.57"/>
</g>
<!-- proc~zinterpolatew1d -->
<g id="proc~~readinitfiles~~CallsGraph_node36" class="node">
<title>proc~zinterpolatew1d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node36"><a xlink:href="../proc/zinterpolatew1d.html" xlink:title="zinterpolatew1d">
<polygon fill="#d9534f" stroke="#d9534f" points="369.5,-108 271.5,-108 271.5,-84 369.5,-84 369.5,-108"/>
<text text-anchor="middle" x="320.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatew1d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolatew1d -->
<g id="proc~~readinitfiles~~CallsGraph_edge32" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolatew1d</title>
<path fill="none" stroke="#7f00ff" d="M218.55,-96C232.07,-96 247.06,-96 261.27,-96"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="261.44,-99.5 271.44,-96 261.44,-92.5 261.44,-99.5"/>
</g>
<!-- proc~slabsum&#45;&gt;mpi_allreduce -->
<g id="proc~~readinitfiles~~CallsGraph_edge33" class="edge">
<title>proc~slabsum&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#ff00ff" d="M471.02,-1036.88C480.68,-1034.74 491.89,-1032.25 502.93,-1029.79"/>
<polygon fill="#ff00ff" stroke="#ff00ff" points="503.98,-1033.15 512.98,-1027.56 502.46,-1026.31 503.98,-1033.15"/>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_edge34" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~avexy_ibm</title>
<path fill="none" stroke="#ff007f" d="M183.12,-885.19C199.26,-903.77 232.73,-938.92 269,-957 309.75,-977.3 361.41,-986.17 397.53,-990.03"/>
<polygon fill="#ff007f" stroke="#ff007f" points="397.45,-993.54 407.75,-991.03 398.14,-986.57 397.45,-993.54"/>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~calc_halflev -->
<g id="proc~~readinitfiles~~CallsGraph_edge35" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~calc_halflev</title>
<path fill="none" stroke="#ff007f" d="M200.25,-860.92C219.44,-852.45 245.74,-840.92 269,-831 272.88,-829.34 276.94,-827.63 280.99,-825.93"/>
<polygon fill="#ff007f" stroke="#ff007f" points="282.48,-829.1 290.35,-822.01 279.78,-822.64 282.48,-829.1"/>
</g>
<!-- proc~calthv -->
<g id="proc~~readinitfiles~~CallsGraph_node16" class="node">
<title>proc~calthv</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node16"><a xlink:href="../proc/calthv.html" xlink:title="calthv">
<polygon fill="#d9534f" stroke="#d9534f" points="347.5,-948 293.5,-948 293.5,-924 347.5,-924 347.5,-948"/>
<text text-anchor="middle" x="320.5" y="-933.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">calthv</text>
</a>
</g>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~calthv -->
<g id="proc~~readinitfiles~~CallsGraph_edge36" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~calthv</title>
<path fill="none" stroke="#ff007f" d="M200.25,-885.08C219.44,-893.55 245.74,-905.08 269,-915 273.79,-917.04 278.85,-919.18 283.83,-921.26"/>
<polygon fill="#ff007f" stroke="#ff007f" points="282.67,-924.57 293.25,-925.19 285.37,-918.11 282.67,-924.57"/>
</g>
<!-- proc~diagfld -->
<g id="proc~~readinitfiles~~CallsGraph_node17" class="node">
<title>proc~diagfld</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node17"><a xlink:href="../proc/diagfld.html" xlink:title="diagfld">
<polygon fill="#d9534f" stroke="#d9534f" points="347.5,-864 293.5,-864 293.5,-840 347.5,-840 347.5,-864"/>
<text text-anchor="middle" x="320.5" y="-849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">diagfld</text>
</a>
</g>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~diagfld -->
<g id="proc~~readinitfiles~~CallsGraph_edge37" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~diagfld</title>
<path fill="none" stroke="#ff007f" d="M223.83,-865.71C243.45,-862.9 265.44,-859.75 283.39,-857.18"/>
<polygon fill="#ff007f" stroke="#ff007f" points="284.04,-860.62 293.44,-855.74 283.05,-853.69 284.04,-860.62"/>
</g>
<!-- proc~thermo -->
<g id="proc~~readinitfiles~~CallsGraph_node19" class="node">
<title>proc~thermo</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node19"><a xlink:href="../proc/thermo.html" xlink:title="thermo">
<polygon fill="#d9534f" stroke="#d9534f" points="347.5,-906 293.5,-906 293.5,-882 347.5,-882 347.5,-906"/>
<text text-anchor="middle" x="320.5" y="-891.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">thermo</text>
</a>
</g>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~thermo -->
<g id="proc~~readinitfiles~~CallsGraph_edge38" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~thermo</title>
<path fill="none" stroke="#ff007f" d="M223.83,-880.29C243.45,-883.1 265.44,-886.25 283.39,-888.82"/>
<polygon fill="#ff007f" stroke="#ff007f" points="283.05,-892.31 293.44,-890.26 284.04,-885.38 283.05,-892.31"/>
</g>
<!-- proc~diagfld&#45;&gt;proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_edge39" class="edge">
<title>proc~diagfld&#45;&gt;proc~avexy_ibm</title>
<path fill="none" stroke="#ffc700" d="M347.73,-859.21C356.15,-862.44 365.08,-866.93 372,-873 403,-900.19 423.63,-944.71 433.89,-971.2"/>
<polygon fill="#ffc700" stroke="#ffc700" points="430.66,-972.56 437.42,-980.71 437.22,-970.12 430.66,-972.56"/>
</g>
<!-- proc~fromztop -->
<g id="proc~~readinitfiles~~CallsGraph_node40" class="node">
<title>proc~fromztop</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node40"><a xlink:href="../proc/fromztop.html" xlink:title="fromztop">
<polygon fill="#d9534f" stroke="#d9534f" points="472.5,-864 412.5,-864 412.5,-840 472.5,-840 472.5,-864"/>
<text text-anchor="middle" x="442.5" y="-849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fromztop</text>
</a>
</g>
</g>
<!-- proc~diagfld&#45;&gt;proc~fromztop -->
<g id="proc~~readinitfiles~~CallsGraph_edge40" class="edge">
<title>proc~diagfld&#45;&gt;proc~fromztop</title>
<path fill="none" stroke="#ffc700" d="M347.54,-852C363.44,-852 384.09,-852 401.98,-852"/>
<polygon fill="#ffc700" stroke="#ffc700" points="402.14,-855.5 412.14,-852 402.14,-848.5 402.14,-855.5"/>
</g>
<!-- mpi_isend -->
<g id="proc~~readinitfiles~~CallsGraph_node37" class="node">
<title>mpi_isend</title>
<polygon fill="#777777" stroke="#777777" points="476,-360 409,-360 409,-336 476,-336 476,-360"/>
<text text-anchor="middle" x="442.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_isend</text>
</g>
<!-- proc~excjs&#45;&gt;mpi_isend -->
<g id="proc~~readinitfiles~~CallsGraph_edge41" class="edge">
<title>proc~excjs&#45;&gt;mpi_isend</title>
<path fill="none" stroke="#f3ff00" d="M347.54,-315.11C362.52,-320.36 381.71,-327.07 398.84,-333.07"/>
<polygon fill="#f3ff00" stroke="#f3ff00" points="398.05,-336.5 408.65,-336.5 400.36,-329.89 398.05,-336.5"/>
</g>
<!-- mpi_recv -->
<g id="proc~~readinitfiles~~CallsGraph_node38" class="node">
<title>mpi_recv</title>
<polygon fill="#777777" stroke="#777777" points="473,-318 412,-318 412,-294 473,-294 473,-318"/>
<text text-anchor="middle" x="442.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_recv</text>
</g>
<!-- proc~excjs&#45;&gt;mpi_recv -->
<g id="proc~~readinitfiles~~CallsGraph_edge42" class="edge">
<title>proc~excjs&#45;&gt;mpi_recv</title>
<path fill="none" stroke="#f3ff00" d="M347.54,-306C363.33,-306 383.79,-306 401.59,-306"/>
<polygon fill="#f3ff00" stroke="#f3ff00" points="401.71,-309.5 411.71,-306 401.71,-302.5 401.71,-309.5"/>
</g>
<!-- mpi_wait -->
<g id="proc~~readinitfiles~~CallsGraph_node39" class="node">
<title>mpi_wait</title>
<polygon fill="#777777" stroke="#777777" points="472.5,-276 412.5,-276 412.5,-252 472.5,-252 472.5,-276"/>
<text text-anchor="middle" x="442.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_wait</text>
</g>
<!-- proc~excjs&#45;&gt;mpi_wait -->
<g id="proc~~readinitfiles~~CallsGraph_edge43" class="edge">
<title>proc~excjs&#45;&gt;mpi_wait</title>
<path fill="none" stroke="#f3ff00" d="M347.54,-296.89C363.59,-291.27 384.48,-283.96 402.48,-277.66"/>
<polygon fill="#f3ff00" stroke="#f3ff00" points="403.86,-280.88 412.14,-274.28 401.55,-274.28 403.86,-280.88"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CallsGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CallsGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.86 0.86) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 Where possible, edges connecting nodes are
given different colours to make them easier to distinguish in
large graphs.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Called by</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (0)
 -->
<!-- Title: proc~~readinitfiles~~CalledByGraph Pages: 1 -->
<svg id="procreadinitfilesCalledByGraph" width="204pt" height="32pt"
 viewBox="0.00 0.00 204.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~readinitfiles~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~readinitfiles~~CalledByGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 200,-28 200,4 -4,4"/>
<!-- proc~readinitfiles -->
<g id="proc~~readinitfiles~~CalledByGraph_node1" class="node">
<title>proc~readinitfiles</title>
<polygon fill="none" stroke="black" points="196,-24 121,-24 121,0 196,0 196,-24"/>
<text text-anchor="middle" x="158.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">readinitfiles</text>
</g>
<!-- program~dalesurban -->
<g id="proc~~readinitfiles~~CalledByGraph_node2" class="node">
<title>program~dalesurban</title>
<g id="a_proc~~readinitfiles~~CalledByGraph_node2"><a xlink:href="../program/dalesurban.html" xlink:title="DALESURBAN">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="85,-24 0,-24 0,0 85,0 85,-24"/>
<text text-anchor="middle" x="42.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">DALESURBAN</text>
</a>
</g>
</g>
<!-- program~dalesurban&#45;&gt;proc~readinitfiles -->
<g id="proc~~readinitfiles~~CalledByGraph_edge1" class="edge">
<title>program~dalesurban&#45;&gt;proc~readinitfiles</title>
<path fill="none" stroke="#ff0000" d="M85.3,-12C93.61,-12 102.39,-12 110.86,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="110.97,-15.5 120.97,-12 110.97,-8.5 110.97,-15.5"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CalledByGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CalledByGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.86 0.86) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 Where possible, edges connecting nodes are
given different colours to make them easier to distinguish in
large graphs.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">   </span><span class="k">subroutine </span><span class="n">readinitfiles</span>
<span class="w">      </span><span class="k">use </span><span class="n">modfields</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">um</span><span class="p">,</span><span class="w"> </span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">wm</span><span class="p">,</span><span class="w"> </span><span class="n">thlm</span><span class="p">,</span><span class="w"> </span><span class="n">thl0</span><span class="p">,</span><span class="w"> </span><span class="n">thl0h</span><span class="p">,</span><span class="w"> </span><span class="n">qtm</span><span class="p">,</span><span class="w"> </span><span class="n">qt0</span><span class="p">,</span><span class="w"> </span><span class="n">qt0h</span><span class="p">,</span><span class="w"> </span><span class="n">uinit</span><span class="p">,</span><span class="w"> </span><span class="n">vinit</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">ql0</span><span class="p">,</span><span class="w"> </span><span class="n">ql0h</span><span class="p">,</span><span class="w"> </span><span class="n">thv0h</span><span class="p">,</span><span class="w"> </span><span class="n">sv0</span><span class="p">,</span><span class="w"> </span><span class="n">svm</span><span class="p">,</span><span class="w"> </span><span class="n">e12m</span><span class="p">,</span><span class="w"> </span><span class="n">e120</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">dudxls</span><span class="p">,</span><span class="w"> </span><span class="n">dudyls</span><span class="p">,</span><span class="w"> </span><span class="n">dvdxls</span><span class="p">,</span><span class="w"> </span><span class="n">dvdyls</span><span class="p">,</span><span class="w"> </span><span class="n">dthldxls</span><span class="p">,</span><span class="w"> </span><span class="n">dthldyls</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">dqtdxls</span><span class="p">,</span><span class="w"> </span><span class="n">dqtdyls</span><span class="p">,</span><span class="w"> </span><span class="n">dqtdtls</span><span class="p">,</span><span class="w"> </span><span class="n">dpdx</span><span class="p">,</span><span class="w"> </span><span class="n">dpdxl</span><span class="p">,</span><span class="w"> </span><span class="n">dpdyl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">wfls</span><span class="p">,</span><span class="w"> </span><span class="n">whls</span><span class="p">,</span><span class="w"> </span><span class="n">ug</span><span class="p">,</span><span class="w"> </span><span class="n">vg</span><span class="p">,</span><span class="w"> </span><span class="n">pgx</span><span class="p">,</span><span class="w"> </span><span class="n">pgy</span><span class="p">,</span><span class="w"> </span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">v0av</span><span class="p">,</span><span class="w"> </span><span class="n">u0av</span><span class="p">,</span><span class="w"> </span><span class="n">qt0av</span><span class="p">,</span><span class="w"> </span><span class="n">ql0av</span><span class="p">,</span><span class="w"> </span><span class="n">thl0av</span><span class="p">,</span><span class="w"> </span><span class="n">qt0av</span><span class="p">,</span><span class="w"> </span><span class="n">sv0av</span><span class="p">,</span><span class="w"> </span><span class="n">exnf</span><span class="p">,</span><span class="w"> </span><span class="n">exnh</span><span class="p">,</span><span class="w"> </span><span class="n">presf</span><span class="p">,</span><span class="w"> </span><span class="n">presh</span><span class="p">,</span><span class="w"> </span><span class="n">rhof</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">thlpcar</span><span class="p">,</span><span class="w"> </span><span class="n">uav</span><span class="p">,</span><span class="w"> </span><span class="n">thvh</span><span class="p">,</span><span class="w"> </span><span class="n">thvf</span><span class="p">,</span><span class="w"> </span><span class="n">IIc</span><span class="p">,</span><span class="w"> </span><span class="n">IIcs</span><span class="p">,</span><span class="w"> </span><span class="n">IIu</span><span class="p">,</span><span class="w"> </span><span class="n">IIus</span><span class="p">,</span><span class="w"> </span><span class="n">IIv</span><span class="p">,</span><span class="w"> </span><span class="n">IIvs</span><span class="p">,</span><span class="w"> </span><span class="n">IIw</span><span class="p">,</span><span class="w"> </span><span class="n">IIws</span><span class="p">,</span><span class="w"> </span><span class="n">u0h</span><span class="p">,</span><span class="w"> </span><span class="n">thl0c</span>
<span class="w">            </span><span class="k">use </span><span class="n">modglobal</span><span class="p">,</span><span class="w">         </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">ihc</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">jhc</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">khc</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">dtmax</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">runtime</span><span class="p">,</span><span class="n">timeleft</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">ntimee</span><span class="p">,</span><span class="n">ntrun</span><span class="p">,</span><span class="n">btime</span><span class="p">,</span><span class="n">dt_lim</span><span class="p">,</span><span class="n">nsv</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">zf</span><span class="p">,</span><span class="w"> </span><span class="n">zh</span><span class="p">,</span><span class="w"> </span><span class="n">dzf</span><span class="p">,</span><span class="w"> </span><span class="n">dzh</span><span class="p">,</span><span class="w"> </span><span class="n">rv</span><span class="p">,</span><span class="w"> </span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">grav</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">,</span><span class="w"> </span><span class="n">rlv</span><span class="p">,</span><span class="w"> </span><span class="n">pref0</span><span class="p">,</span><span class="w"> </span><span class="n">om23_gs</span><span class="p">,</span><span class="w"> </span><span class="n">jgb</span><span class="p">,</span><span class="w"> </span><span class="n">jge</span><span class="p">,</span><span class="w"> </span><span class="n">Uinf</span><span class="p">,</span><span class="w"> </span><span class="n">Vinf</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">rslabs</span><span class="p">,</span><span class="w"> </span><span class="n">e12min</span><span class="p">,</span><span class="w"> </span><span class="n">dzh</span><span class="p">,</span><span class="w"> </span><span class="n">dtheta</span><span class="p">,</span><span class="w"> </span><span class="n">dqt</span><span class="p">,</span><span class="w"> </span><span class="n">dsv</span><span class="p">,</span><span class="w"> </span><span class="n">cexpnr</span><span class="p">,</span><span class="w"> </span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="n">lwarmstart</span><span class="p">,</span><span class="w"> </span><span class="n">lstratstart</span><span class="p">,</span><span class="w"> </span><span class="n">trestart</span><span class="p">,</span><span class="w"> </span><span class="n">numol</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">ladaptive</span><span class="p">,</span><span class="w"> </span><span class="n">tnextrestart</span><span class="p">,</span><span class="w"> </span><span class="n">jmax</span><span class="p">,</span><span class="w"> </span><span class="n">imax</span><span class="p">,</span><span class="w"> </span><span class="n">xh</span><span class="p">,</span><span class="w"> </span><span class="n">xf</span><span class="p">,</span><span class="w"> </span><span class="n">linoutflow</span><span class="p">,</span><span class="w"> </span><span class="n">lper2inout</span><span class="p">,</span><span class="w"> </span><span class="n">iinletgen</span><span class="p">,</span><span class="w"> </span><span class="n">lreadminl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">uflowrate</span><span class="p">,</span><span class="w"> </span><span class="n">vflowrate</span><span class="p">,</span><span class="n">ltempeq</span><span class="p">,</span><span class="w"> </span><span class="n">prandtlmoli</span><span class="p">,</span><span class="w"> </span><span class="n">freestreamav</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">tnextfielddump</span><span class="p">,</span><span class="w"> </span><span class="n">tfielddump</span><span class="p">,</span><span class="w"> </span><span class="n">tsample</span><span class="p">,</span><span class="w"> </span><span class="n">tstatsdump</span><span class="p">,</span><span class="w"> </span><span class="n">startfile</span><span class="p">,</span><span class="w"> </span><span class="n">lprofforc</span><span class="p">,</span><span class="w"> </span><span class="n">lchem</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="n">JNO2</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">idriver</span><span class="p">,</span><span class="n">dtdriver</span><span class="p">,</span><span class="n">driverstore</span><span class="p">,</span><span class="n">tdriverstart</span><span class="p">,</span><span class="n">tdriverstart_cold</span><span class="p">,</span><span class="n">tdriverdump</span><span class="p">,</span><span class="n">lchunkread</span><span class="p">,</span><span class="n">xlen</span><span class="p">,</span><span class="n">ylen</span><span class="p">,</span><span class="n">itot</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">ibrank</span><span class="p">,</span><span class="n">ierank</span><span class="p">,</span><span class="n">jbrank</span><span class="p">,</span><span class="n">jerank</span><span class="p">,</span><span class="n">BCxm</span><span class="p">,</span><span class="n">BCym</span><span class="p">,</span><span class="n">lrandomize</span><span class="p">,</span><span class="n">BCxq</span><span class="p">,</span><span class="n">BCxs</span><span class="p">,</span><span class="n">BCxT</span><span class="p">,</span><span class="w"> </span><span class="n">BCyq</span><span class="p">,</span><span class="n">BCys</span><span class="p">,</span><span class="n">BCyT</span><span class="p">,</span><span class="n">BCxm_driver</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">tEB</span><span class="p">,</span><span class="n">tnextEB</span><span class="p">,</span><span class="n">dtEB</span><span class="p">,</span><span class="n">BCxs_custom</span><span class="p">,</span><span class="n">lEB</span><span class="p">,</span><span class="n">lfacTlyrs</span><span class="p">,</span><span class="n">tfac</span><span class="p">,</span><span class="n">tnextfac</span><span class="p">,</span><span class="n">dtfac</span>
<span class="w">      </span><span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">ekm</span><span class="p">,</span><span class="w"> </span><span class="n">ekh</span><span class="p">,</span><span class="w"> </span><span class="n">loneeqn</span>
<span class="w">      </span><span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">wtsurf</span><span class="p">,</span><span class="w"> </span><span class="n">wqsurf</span><span class="p">,</span><span class="w"> </span><span class="n">wsvsurf</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">thls</span><span class="p">,</span><span class="w"> </span><span class="n">thvs</span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="p">,</span><span class="w"> </span><span class="n">qts</span><span class="p">,</span><span class="w"> </span><span class="n">svs</span><span class="p">,</span><span class="w"> </span><span class="n">sv_top</span>
<span class="w">      </span><span class="c">! use modsurface,        only : surface,dthldz</span>
<span class="w">      </span><span class="k">use </span><span class="n">modboundary</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">boundary</span><span class="p">,</span><span class="w"> </span><span class="n">tqaver</span><span class="p">,</span><span class="w"> </span><span class="n">halos</span>
<span class="w">      </span><span class="k">use </span><span class="n">modmpi</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">slabsum</span><span class="p">,</span><span class="w"> </span><span class="n">myid</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">,</span><span class="w"> </span><span class="n">my_real</span><span class="p">,</span><span class="w"> </span><span class="n">avexy_ibm</span><span class="p">,</span><span class="w"> </span><span class="n">myidx</span><span class="p">,</span><span class="w"> </span><span class="n">myidy</span>
<span class="w">      </span><span class="k">use </span><span class="n">modthermodynamics</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">thermodynamics</span><span class="p">,</span><span class="w"> </span><span class="n">calc_halflev</span>
<span class="w">      </span><span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">Uinl</span><span class="p">,</span><span class="w"> </span><span class="n">Urec</span><span class="p">,</span><span class="w"> </span><span class="n">Wrec</span><span class="p">,</span><span class="w"> </span><span class="n">u0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">v0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">w0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span><span class="p">,</span><span class="w"> </span><span class="n">vbulk</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="p">,</span><span class="w"> </span><span class="n">Utav</span><span class="p">,</span><span class="w"> </span><span class="n">Ttav</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">uminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">vminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">wminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">u0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="n">v0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="n">w0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">storeu0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">,</span><span class="w"> </span><span class="n">nfile</span><span class="p">,</span><span class="w"> </span><span class="n">Tinl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">Trec</span><span class="p">,</span><span class="w"> </span><span class="n">tminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">t0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="n">t0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">storet0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">utaui</span><span class="p">,</span><span class="w"> </span><span class="n">ttaui</span><span class="p">,</span><span class="w"> </span><span class="n">iangle</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">u0driver</span><span class="p">,</span><span class="n">umdriver</span><span class="p">,</span><span class="n">v0driver</span><span class="p">,</span><span class="n">vmdriver</span><span class="p">,</span><span class="n">w0driver</span><span class="p">,</span><span class="n">e120driver</span><span class="p">,</span><span class="n">tdriver</span><span class="p">,</span><span class="n">thl0driver</span><span class="p">,</span><span class="n">qt0driver</span><span class="p">,</span><span class="n">storetdriver</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">storeu0driver</span><span class="p">,</span><span class="n">storeumdriver</span><span class="p">,</span><span class="n">storev0driver</span><span class="p">,</span><span class="n">storew0driver</span><span class="p">,</span><span class="n">storee120driver</span><span class="p">,</span><span class="n">storethl0driver</span><span class="p">,</span><span class="n">storeqt0driver</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">nstepreaddriver</span>
<span class="w">      </span><span class="k">use </span><span class="n">modinlet</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">readinletfile</span>
<span class="w">      </span><span class="k">use </span><span class="n">moddriver</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">readdriverfile</span><span class="p">,</span><span class="n">initdriver</span><span class="p">,</span><span class="n">drivergen</span><span class="p">,</span><span class="n">readdriverfile_chunk</span>
<span class="w">      </span><span class="k">use </span><span class="n">decomp_2d</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">exchange_halo_z</span><span class="p">,</span><span class="w"> </span><span class="n">update_halo</span><span class="p">,</span><span class="w"> </span><span class="n">decomp_main</span>

<span class="w">      </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>

<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">height</span><span class="p">(:),</span><span class="w"> </span><span class="n">th0av</span><span class="p">(:)</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jh</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">thv0</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uaverage</span><span class="w"> </span><span class="c">! volume averaged u-velocity</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vaverage</span><span class="w"> </span><span class="c">! volume averaged v-velocity</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uaverager</span><span class="w"> </span><span class="c">! recycle plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uaveragei</span><span class="w"> </span><span class="c">! inlet plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">taverager</span><span class="w"> </span><span class="c">! recycle plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">taveragei</span><span class="w"> </span><span class="c">! inlet plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">waverage</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uprofrot</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vprofrot</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">u_init</span><span class="p">,</span><span class="w"> </span><span class="n">v_init</span><span class="p">,</span><span class="w"> </span><span class="n">thl_init</span><span class="p">,</span><span class="w"> </span><span class="n">qt_init</span>
<span class="w">      </span><span class="kt">real </span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>

<span class="w">      </span><span class="kt">character</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">      </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">height</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span>
<span class="w">      </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lstratstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! Switch</span>

<span class="w">         </span><span class="c">! Read restart files as in lwarmstart</span>
<span class="w">         </span><span class="k">call </span><span class="n">readrestartfiles</span>
<span class="w">         </span><span class="n">um</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>
<span class="w">         </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span>
<span class="w">         </span><span class="n">wm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w0</span>
<span class="w">         </span><span class="n">thlm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="w"> </span><span class="c">!do this before or just not?</span>
<span class="w">         </span><span class="n">qtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt0</span>
<span class="w">         </span><span class="n">svm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sv0</span>
<span class="w">         </span><span class="n">e12m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e120</span>

<span class="w">         </span><span class="c">! Overwrite thlm, thl0, qtm, qt0 from prof.inp.xxx</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">            </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">            </span><span class="c">!write (*, &#39;(a80)&#39;) chmess</span>
<span class="w">            </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">            </span><span class="c">! write (*, *) &#39;height    thl     qt      u      v     e12&#39;</span>
<span class="w">            </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">            </span><span class="c">!    write (*, &#39;(f7.1,2f8.1,3f7.1)&#39;) &amp;</span>
<span class="w">            </span><span class="c">!       height(k), &amp;</span>
<span class="w">            </span><span class="c">!       thlprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       qtprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       uprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       vprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       e12prof(k)</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">! end do</span>
<span class="w">         </span><span class="k">end if</span><span class="w"> </span><span class="c">!myid=0</span>

<span class="w">         </span><span class="c">! MPI broadcast thl and qt</span>
<span class="w">         </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">         </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">thlm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">qtm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">         end do</span>

<span class="w">         </span><span class="c">!ILS13 reintroduced thv !tg3315 this part may wrong, could need to use</span>
<span class="w">         </span><span class="k">call </span><span class="n">calc_halflev</span>
<span class="w">         </span><span class="c">! exnf = (presf/pref0)**(rd/cp)  !exner functions not in restart files</span>
<span class="w">         </span><span class="c">! anymore.. or at least not read</span>
<span class="w">         </span><span class="c">! exnh = (presh/pref0)**(rd/cp)</span>

<span class="w">         </span><span class="c">!   write(*,*) &quot;exnf&quot;,enf</span>
<span class="w">         </span><span class="c">!   write(*,*) &quot;exnh&quot;,exnh</span>
<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">                  </span><span class="c">!write(*,*) &quot;thl0h&quot;,thl0h(i,j,k)</span>
<span class="w">                  </span><span class="n">thv0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                   </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">         end do</span>

<span class="k">         do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">                  </span><span class="n">thv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                  </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">         end do</span>

<span class="k">         </span><span class="n">thvh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">         </span><span class="c">! call slabsum(thvh,kb,ke,thv0h,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke) ! redefine halflevel thv using calculated thv</span>
<span class="w">         </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIw</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIws</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">         </span><span class="c">! thvh = thvh/rslabs</span>

<span class="w">         </span><span class="n">thvf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">         </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">         </span><span class="c">! call slabsum(thvf,kb,ke,thv0,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke)</span>
<span class="w">         </span><span class="c">! thvf = thvf/rslabs</span>

<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="c">!if not lstratstart</span>

<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">lwarmstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">            </span><span class="c">!********************************************************************</span>

<span class="w">            </span><span class="c">!    1.0 prepare initial fields from files &#39;prof.inp&#39; and &#39;scalar.inp&#39;</span>
<span class="w">            </span><span class="c">!    ----------------------------------------------------------------</span>

<span class="w">            </span><span class="c">!--------------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!    1.1 read fields</span>
<span class="w">            </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">            </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtmax</span><span class="o">/</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">            </span><span class="n">timee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">               </span><span class="c">!write (*, &#39;(a80)&#39;) chmess</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>

<span class="w">               </span><span class="c">! Apply rotation in horizontal</span>
<span class="w">               </span><span class="c">!write (6, *) &#39;iangle = &#39;, iangle</span>

<span class="w">               </span><span class="c">!uprofrot = uprof*cos(iangle) - vprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!vprofrot = vprof*cos(iangle) + uprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!uprof = uprofrot</span>
<span class="w">               </span><span class="c">!vprof = vprofrot</span>

<span class="w">               </span><span class="k">close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>
<span class="w">               </span><span class="c">! write (*, *) &#39;height    thl     qt      u      v     e12&#39;</span>
<span class="w">               </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">               </span><span class="c">!    !write (*, &#39;(f7.1,2f8.1,3f7.1)&#39;) &amp;</span>
<span class="w">               </span><span class="c">!    write (*, *) &amp;</span>
<span class="w">               </span><span class="c">!       height(k), &amp;</span>
<span class="w">               </span><span class="c">!       thlprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       qtprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       uprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       vprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       e12prof(k)</span>
<span class="w">               </span><span class="c">!</span>
<span class="w">               </span><span class="c">! end do</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                 if</span><span class="w"> </span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                   write</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;e12 value is zero (or less) in prof.inp&#39;</span>
<span class="w">                   </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span>
<span class="w">                   </span><span class="k">end do</span>
<span class="k">                 end if</span>
<span class="k">               end if</span>

<span class="k">            end if</span><span class="w"> </span><span class="c">! end if myid==0</span>
<span class="w">            </span><span class="c">! MPI broadcast numbers reading</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">thlm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">qtm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">               </span><span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">               </span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">e12m</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="c">!        ekm (i,j,k) = 0.0</span>
<span class="w">               </span><span class="c">!        ekh (i,j,k) = 0.0</span>
<span class="w">               </span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span>
<span class="w">               </span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">            end do</span>

<span class="k">            do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jhc</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jhc</span>
<span class="w">                  </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ihc</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ihc</span>
<span class="w">                     </span><span class="n">thl0c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">            end do</span>

<span class="w">            </span><span class="c">! if (ibrank) then</span>
<span class="w">            </span><span class="c">! do j=jb-1,je+1</span>
<span class="w">            </span><span class="c">!   um(ib,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">!   um(ib-1,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">! end do</span>
<span class="w">            </span><span class="c">! end if</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">! if (ierank) then</span>
<span class="w">            </span><span class="c">! do j=jb-1,je+1</span>
<span class="w">            </span><span class="c">!   !um(ie,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">!   um(ie+1,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">! end do</span>
<span class="w">            </span><span class="c">! end if</span>


<span class="w">            </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! also for start up</span>

<span class="w">            </span><span class="c">! ILS13 30.11.17, added, not sure if necessary</span>
<span class="w">            </span><span class="c">! ILS13 30.11.1, commented</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jh</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jh</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ih</span>
<span class="w">                  </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>

<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">lrandomize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">              </span><span class="c">!! add random fluctuations</span>
<span class="w">              </span><span class="n">krand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">krand</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">              </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">krand</span>
<span class="w">                </span><span class="k">call </span><span class="n">randomnize</span><span class="p">(</span><span class="n">um</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">randu</span><span class="p">,</span><span class="w"> </span><span class="n">irandom</span><span class="p">,</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jh</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">              do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">krand</span>
<span class="w">                </span><span class="k">call </span><span class="n">randomnize</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">randu</span><span class="p">,</span><span class="w"> </span><span class="n">irandom</span><span class="p">,</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jh</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">              do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">krand</span>
<span class="w">                </span><span class="k">call </span><span class="n">randomnize</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">randu</span><span class="p">,</span><span class="w"> </span><span class="n">irandom</span><span class="p">,</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jh</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">            end if</span>

<span class="w">            </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">            </span><span class="c">!       do j=jb,je</span>
<span class="w">            </span><span class="c">!       do i=ib+1,ie-1</span>
<span class="w">            </span><span class="c">!         call random_number(ran)</span>
<span class="w">            </span><span class="c">!         ran1 = -1. +2.*ran</span>
<span class="w">            </span><span class="c">!         wm(i,j,k)=wm(i,j,k)+ 0.1*Uinf*ran1</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">            </span><span class="c">!       do j=jb,je</span>
<span class="w">            </span><span class="c">!       do i=ib+2,ie-1</span>
<span class="w">            </span><span class="c">!         call random_number(ran)</span>
<span class="w">            </span><span class="c">!         ran1 = -1. +2.*ran</span>
<span class="w">            </span><span class="c">!         um(i,j,k)=um(i,j,k)+ 0.1*Uinf*ran1</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">            </span><span class="c">!       do j=jb,je</span>
<span class="w">            </span><span class="c">!       do i=ib+1,ie-1</span>
<span class="w">            </span><span class="c">!         call random_number(ran)</span>
<span class="w">            </span><span class="c">!         ran1 = -1. +2.*ran</span>
<span class="w">            </span><span class="c">!         vm(i,j,k)=vm(i,j,k)+ 0.1*Uinf*ran1</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>

<span class="w">            </span><span class="c">! SO: Manually override fields</span>

<span class="w">            </span><span class="c">! if (((BCxm == 1) .and. (BCym == 1)) .or. ((BCxm == 6) .and. (BCym == 6))) then</span>
<span class="w">            </span><span class="c">!   ! TGV (assumes equidistant x grid)</span>
<span class="w">            </span><span class="c">!   do i = ib-1,ie+1</span>
<span class="w">            </span><span class="c">!     do j = jb-1,je+1</span>
<span class="w">            </span><span class="c">!       do k = kb-1,ke+1</span>
<span class="w">            </span><span class="c">!         um(i,j,k) = 1. * sin(4.*atan(1.) * 2. * (dx*((i-1)+myidx*imax)) / ylen) &amp;</span>
<span class="w">            </span><span class="c">!         * cos(4.*atan(1.) * 2. * (dy*((0.5+(j-1))+myidy*jmax)) / ylen) !&amp;</span>
<span class="w">            </span><span class="c">!         !* cos(4.*atan(1.) * 2. * zf(k) / ylen)</span>
<span class="w">            </span><span class="c">!         vm(i,j,k) = 1. *-cos(4.*atan(1.) * 2. * (dx*((0.5+(i-1))+myidx*imax)) / ylen)  &amp;</span>
<span class="w">            </span><span class="c">!         * sin(4.*atan(1.) * 2. * (dy*((j-1)+myidy*jmax)) / ylen) !&amp;</span>
<span class="w">            </span><span class="c">!         !* cos(4.*atan(1.) * 2. * zf(k) / ylen)</span>
<span class="w">            </span><span class="c">!         wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end if</span>

<span class="w">            </span><span class="c">! ! For shear case</span>
<span class="w">            </span><span class="c">! um(:,:,ke+1) = um(:,:,ke)</span>
<span class="w">            </span><span class="c">! um(ib-1,:,:) = um(ib,:,:)</span>
<span class="w">            </span><span class="c">! um(ie-1,:,:) = um(ie,:,:)</span>
<span class="w">            </span><span class="c">! um(:,jb-1,:) = um(:,jb,:)</span>
<span class="w">            </span><span class="c">! um(:,je+1,:) = um(:,je,:)</span>

<span class="w">            </span><span class="n">u0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span>
<span class="w">            </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>
<span class="w">            </span><span class="n">w0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span>

<span class="w">            </span><span class="k">call </span><span class="n">halos</span>

<span class="w">            </span><span class="n">uinit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span>
<span class="w">            </span><span class="n">vinit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>

<span class="w">            </span><span class="c">! ! zeros</span>
<span class="w">            </span><span class="c">! do i = ib,ie</span>
<span class="w">            </span><span class="c">!   do j = jb,je</span>
<span class="w">            </span><span class="c">!     do k = kb,ke</span>
<span class="w">            </span><span class="c">!       um(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       u0(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       uinit(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       vm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       v0(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       vinit(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       w0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end do</span>

<span class="w">            </span><span class="c">! ! ones</span>
<span class="w">            </span><span class="c">! do i = ib,ie</span>
<span class="w">            </span><span class="c">!   do j = jb,je</span>
<span class="w">            </span><span class="c">!     do k = kb,ke</span>
<span class="w">            </span><span class="c">!       um(i,j,k) = 1.</span>
<span class="w">            </span><span class="c">!       u0(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       uinit(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       vm(i,j,k) = 1.</span>
<span class="w">            </span><span class="c">!       v0(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       vinit(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       w0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end do</span>

<span class="w">            </span><span class="c">! do i = ib,ie</span>
<span class="w">            </span><span class="c">!   do j = jb,je</span>
<span class="w">            </span><span class="c">!     do k = kb,ke</span>
<span class="w">            </span><span class="c">!       um(i,j,k) = (i + myidx*imax) * (j + myidy*jmax)</span>
<span class="w">            </span><span class="c">!       u0(i,j,k) = (i + myidx*imax) * (j + myidy*jmax)</span>
<span class="w">            </span><span class="c">!       vm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       v0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       w0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end do</span>

<span class="w">            </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="c">! call slabsum(uaverage, kb, ke, um, ib - 1, ie + 1, jb - 1, je + 1, kb - 1, ke + 1, ib, ie, jb, je, kb, ke)</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! averaged u-velocity inflow profile</span>
<span class="w">            </span><span class="c">!write (6, *) &#39;Modstartup: ubulk=&#39;, ubulk</span>
<span class="w">            </span><span class="n">vaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="c">! call slabsum(vaverage, kb, ke, vm, ib - 1, ie + 1, jb - 1, je + 1, kb - 1, ke + 1, ib, ie, jb, je, kb, ke)</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="n">vaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            </span><span class="n">vbulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">vaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! averaged u-velocity inflow profile</span>

<span class="w">            </span><span class="c">! Set average inlet profile to initial inlet profile in case of inletgenerator mode</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">um</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>
<span class="w">               </span><span class="n">Utav</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">Uinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to um</span>
<span class="w">               </span><span class="n">Urec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to um</span>
<span class="w">               </span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean w-profile</span>
<span class="w">               </span><span class="n">u0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">vminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">wminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">utaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)))</span><span class="w"> </span><span class="c">! average streamwise friction at inlet (need for first time step)</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">Ttav</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to thlm</span>
<span class="w">                  </span><span class="n">Tinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to thlm</span>
<span class="w">                  </span><span class="n">Trec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to thlm</span>
<span class="w">                  </span><span class="n">t0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">t0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">tminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ttaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">Tinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">utaui</span><span class="p">)</span><span class="w"> </span><span class="c">! average friction temp. at inlet (need for first time step)</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">               </span><span class="c">! add random perturbations</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end if</span>

<span class="k">               do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">48</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">               end do</span>

<span class="w">               </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">48</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">               end do</span>

<span class="w">               </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">48</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">               end do</span>

<span class="k">               </span><span class="n">u0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span>
<span class="w">               </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>
<span class="w">               </span><span class="n">w0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span>

<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               </span><span class="n">nfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nfile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">call </span><span class="n">readinletfile</span>
<span class="w">               </span><span class="n">u0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">uminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">vminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">wminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>

<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! idriver</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibrank</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">lchunkread</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                      call </span><span class="n">readdriverfile_chunk</span>
<span class="w">                  </span><span class="k">else</span>
<span class="k">                     call </span><span class="n">readdriverfile</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  call </span><span class="n">drivergen</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">               </span><span class="c">! do k = kb, ke</span>
<span class="w">               </span><span class="c">!    do j = jb-1, je+1</span>
<span class="w">               </span><span class="c">!       do i = ib-1, ie+1</span>
<span class="w">               </span><span class="c">!          u0(i, j, k) = u0driver(j, k)</span>
<span class="w">               </span><span class="c">!          um(i, j, k) = umdriver(j, k)</span>
<span class="w">               </span><span class="c">!          v0(i, j, k) = v0driver(j, k)</span>
<span class="w">               </span><span class="c">!          vm(i, j, k) = vmdriver(j, k)</span>
<span class="w">               </span><span class="c">!       end do</span>
<span class="w">               </span><span class="c">!    end do</span>
<span class="w">               </span><span class="c">! end do</span>

<span class="w">               </span><span class="c">! if(myid==0) then</span>
<span class="w">                 </span><span class="c">! write(*,*) &#39;Driver inlet velocity&#39;</span>
<span class="w">                 </span><span class="c">! do n=1,driverstore</span>
<span class="w">                   </span><span class="c">! write (*,&#39;(f9.2,e20.12)&#39;) storetdriver(n),     storeu0driver(1,32,n)</span>
<span class="w">                 </span><span class="c">! end do</span>
<span class="w">               </span><span class="c">! endif</span>

<span class="w">              </span><span class="c">! call slabsum(uaverage,kb,ke,u0,ib-1,ie+1,jb-1,je+1,kb-1,ke+1,ib,ie,jb,je,kb,ke)</span>
<span class="w">              </span><span class="c">! uaverage = uaverage / ((ie-ib+1)*(jge-jgb+1))  ! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>

<span class="w">              </span><span class="c">! call avexy_ibm(uaverage(kb:ke),u0(ib:ie,jb:je,kb:ke),ib,ie,jb,je,kb,ke,ih,jh,kh,IIu(ib:ie,jb:je,kb:ke),IIus(kb:ke),.false.)</span>
<span class="w">              </span><span class="c">! do k=kb,ke</span>
<span class="w">              </span><span class="c">!   uaverage(k) = uaverage(k)*dzf(k)</span>
<span class="w">              </span><span class="c">! end do</span>
<span class="w">              </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">!volume-averaged u-velocity</span>

<span class="w">              </span><span class="c">! if (myid==0) then</span>
<span class="w">              </span><span class="c">!    write(6,*) &#39;Modstartup: ubulk=&#39;,ubulk</span>
<span class="w">              </span><span class="c">! end if</span>

<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">runtime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tdriverstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! No driver files will be written as runtime &lt; tdriverstart.&#39;</span>
<span class="w">               </span><span class="k">else</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">trestart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">trestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! for driver simulation, trestart gets set as &amp;</span>
<span class="s1">                                           (tdriverstart + (driverstore-1)*dtdriver), ignoring the &amp;</span>
<span class="s1">                                           trestart mentioned in namoptions. Hence, trestart = &#39;</span><span class="p">,(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runtime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">tdriverstart</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">runtime</span><span class="o">+</span><span class="mf">1e-10</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! Driver files cannot be written upto &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">driverstore</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; steps. &amp;</span>
<span class="s1">                                    Consider taking runtime &gt;= (tdriverstart + (driverstore-1)*dtdriver).&#39;</span>
<span class="w">                     </span><span class="k">end if</span>
<span class="k">                  end if</span>
<span class="k">               end if</span>

<span class="k">              call </span><span class="n">drivergen</span>

<span class="w">            </span><span class="k">end if</span>

<span class="w">            </span><span class="c">!---------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!  1.2 randomnize fields</span>
<span class="w">            </span><span class="c">!---------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!     if (iinletgen /= 2 .and. iinletgen /= 1) then</span>
<span class="w">            </span><span class="c">!       write(6,*) &#39;randomnizing temperature!&#39;</span>
<span class="w">            </span><span class="c">!       krand  = min(krand,ke)</span>
<span class="w">            </span><span class="c">!        do k = kb,ke !edited tg3315 krand --&gt; ke</span>
<span class="w">            </span><span class="c">!          call randomnize(thlm,k,randthl,irandom,ih,jh)</span>
<span class="w">            </span><span class="c">!          call randomnize(thl0,k,randthl,irandom,ih,jh)</span>
<span class="w">            </span><span class="c">!        end do</span>
<span class="w">            </span><span class="c">!       end if</span>

<span class="w">            </span><span class="n">svprof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="w">                  </span><span class="c">! open (ifinput, file=&#39;scalar.inp.&#39;//cexpnr)</span>
<span class="w">                  </span><span class="c">! write (6, *) &#39;height   sv(1) --------- sv(nsv) &#39;</span>
<span class="w">                  </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">                  </span><span class="c">!    write (6, *) &amp;</span>
<span class="w">                  </span><span class="c">!       height(k), &amp;</span>
<span class="w">                  </span><span class="c">!       (svprof(k, n), n=1, nsv)</span>
<span class="w">                  </span><span class="c">! end do</span>

<span class="w">               </span><span class="k">end if</span>
<span class="k">            end if</span><span class="w"> </span><span class="c">! end if myid==0</span>

<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span><span class="o">*</span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BCxs</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">BCxs_custom</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                     </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                        </span><span class="k">do </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span>
<span class="w">                           </span><span class="n">sv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">                           </span><span class="n">svm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">                        </span><span class="k">end do</span>
<span class="k">                     end do</span>
<span class="k">                  end do</span>
<span class="k">               end do</span>
<span class="k">            end if</span>

<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">!tg3315 set these variables here for now and repeat for warmstart</span>

<span class="w">              </span><span class="k">allocate</span><span class="p">(</span><span class="n">sv_top</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">))</span>
<span class="w">              </span><span class="n">sv_top</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">)</span>

<span class="w">              </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">sv_top</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">              </span><span class="c">!write(*,*) &#39;svprof&#39;, svprof</span>
<span class="w">              </span><span class="c">!write(*,*) &#39;sv_top&#39;, sv_top</span>

<span class="w">            </span><span class="k">end if</span>

<span class="w">            </span><span class="c">!do n = 1,nsv</span>
<span class="w">            </span><span class="c">!  do j = jb - jhc, je + jhc</span>
<span class="w">            </span><span class="c">!    do i = ib - ihc, ie + ihc</span>
<span class="w">            </span><span class="c">!      svm(i, j, ke + 1, n) = svm(i, j, ke)</span>
<span class="w">            </span><span class="c">!      sv0(i, j, kb - 1, n) = sv0(i, j, kb)</span>
<span class="w">            </span><span class="c">!    end do</span>
<span class="w">            </span><span class="c">!  end do</span>
<span class="w">            </span><span class="c">!end do</span>

<span class="w">            </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!    2.2 Initialize surface layer</span>
<span class="w">            </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">         </span><span class="c">!ILS13 reintroduced thv !tg3315 this part may wrong, could need to use</span>
<span class="w">         </span><span class="k">call </span><span class="n">calc_halflev</span>
<span class="w">         </span><span class="c">! exnf = (presf/pref0)**(rd/cp)  !exner functions not in restart files</span>
<span class="w">         </span><span class="c">! anymore.. or at least not read</span>
<span class="w">         </span><span class="c">! exnh = (presh/pref0)**(rd/cp)</span>
<span class="w">         </span><span class="c">!</span>
<span class="w">         </span><span class="c">! call boundary ! tg3315 17.10.17 having this in startup was causing issues for running with lmoist ! turned of when pot. temp = temp.</span>
<span class="w">         </span><span class="c">! SO: can&#39;t do this yet because uses u0 and it does not include halo cells</span>
<span class="w">         </span><span class="k">call </span><span class="n">thermodynamics</span><span class="w"> </span><span class="c">! turned off when pot. temp = temp.</span>
<span class="w">         </span><span class="c">!</span>
<span class="w">         </span><span class="c">!    call boundary</span>
<span class="w">         </span><span class="c">!    call thermodynamics ! turned off when pot. temp = temp.</span>

<span class="w">         </span><span class="k">else</span><span class="w"> </span><span class="c">!if lwarmstart</span>
<span class="w">            </span><span class="c">!write (*, *) &quot;doing warmstart&quot;</span>
<span class="w">            </span><span class="k">call </span><span class="n">readrestartfiles</span>

<span class="w">            </span><span class="c">! average initial profiles</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">u_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIus</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">v_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIvs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thl_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">qt_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">               </span><span class="c">! Read profiles from file (potentially for forcing)</span>
<span class="w">               </span><span class="k">open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">               </span><span class="c">!write (*, &#39;(a80)&#39;) chmess</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">               </span><span class="c">! Write initial profile</span>
<span class="w">               </span><span class="k">open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof_restart.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;# SDBL flow&#39;</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;# z thl qt u v e12&#39;</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(f20.15,5f12.6)&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">thl_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">qt_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">u_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">v_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">               </span><span class="c">! Apply rotation in horizontal</span>
<span class="w">               </span><span class="c">!write (6, *) &#39;iangle = &#39;, iangle</span>

<span class="w">               </span><span class="c">!uprofrot = uprof*cos(iangle) - vprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!vprofrot = vprof*cos(iangle) + uprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!uprof = uprofrot</span>
<span class="w">               </span><span class="c">!vprof = vprofrot</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                 if</span><span class="w"> </span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                   write</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;e12 value is zero (or less) in prof.inp&#39;</span>
<span class="w">                   </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span>
<span class="w">                   </span><span class="k">end do</span>
<span class="k">                 end if</span>
<span class="k">               end if</span>

<span class="k">            end if</span><span class="w"> </span><span class="c">! end if myid==0</span>
<span class="w">            </span><span class="c">! MPI broadcast numbers reading</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="n">btime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timee</span>
<span class="w">            </span><span class="n">um</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>
<span class="w">            </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span>
<span class="w">            </span><span class="n">wm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w0</span>
<span class="w">            </span><span class="n">thlm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span>
<span class="w">            </span><span class="n">qtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt0</span>
<span class="w">            </span><span class="n">svm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sv0</span><span class="w"> </span><span class="c">! What if nsv=0?</span>
<span class="w">            </span><span class="n">e12m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e120</span>
<span class="w">            </span><span class="n">ekm</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span>
<span class="w">            </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="w"> </span><span class="c">!tg3315 added because wttop using ekh in modboundary which is called in startup</span>

<span class="w">            </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! also for start up</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">              </span><span class="c">!driverstore = (timeleft - tdriverstart)/dtdriver + 1</span>
<span class="w">              </span><span class="c">!if(myid==0) then</span>
<span class="w">              </span><span class="c">!  write(*,*) &#39;driverstore: &#39;, driverstore</span>
<span class="w">              </span><span class="c">!end if</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timee</span><span class="o">&gt;=</span><span class="n">tdriverstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                  </span><span class="n">tdriverstart_cold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tdriverstart</span>
<span class="w">                  </span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timee</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trestart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">trestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span>
<span class="w">                  </span><span class="k">end if</span>

<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Warning! during warmstart of driver simulation, tdriverstart &amp;</span>
<span class="s2">                                           gets overwritten by the time instant of initd restartfile, ignoring the &amp;</span>
<span class="s2">                                           tdriverstart mentioned in namoptions. Hence, tdriverstart = &quot;</span><span class="p">,</span><span class="n">timee</span>
<span class="w">                     </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! for this driver simulation, trestart gets set as &amp;</span>
<span class="s1">                                           (driverstore-1)*dtdriver, ignoring the trestart mentioned &amp;</span>
<span class="s1">                                           in namoptions. Hence, trestart = &#39;</span><span class="p">,(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! Driver files cannot be written upto &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">driverstore</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; steps. &amp;</span>
<span class="s1">                                    Consider taking runtime &gt;= (driverstore-1)*dtdriver).&#39;</span>
<span class="w">                     </span><span class="k">end if</span>
<span class="k">                  end if</span>

<span class="k">               else</span><span class="w"> </span><span class="c">! if (timee&lt;tdriverstart)</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trestart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">btime</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">trestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">btime</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! for this driver simulation, trestart gets set as &amp;</span>
<span class="s1">                                           (tdriverstart + (driverstore-1)*dtdriver - btime), ignoring the &amp;</span>
<span class="s1">                                           trestart mentioned in namoptions. Hence, trestart = &#39;</span><span class="p">,(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">btime</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">timee</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">runtime</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! Driver files cannot be written upto &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">driverstore</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; steps. &amp;</span>
<span class="s1">                                    Consider taking runtime + &#39;</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="s1">&#39; &gt;= (tdriverstart + (driverstore-1)*dtdriver).&#39;</span>
<span class="w">                     </span><span class="k">end if</span>
<span class="k">                  end if</span>
<span class="k">               end if</span>

<span class="k">              call </span><span class="n">drivergen</span>
<span class="w">              </span><span class="n">tdriverdump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tdriverstart</span>
<span class="w">            </span><span class="k">endif</span>

<span class="w">            </span><span class="c">!ILS13 reintroduced thv</span>
<span class="w">            </span><span class="k">call </span><span class="n">calc_halflev</span>
<span class="w">            </span><span class="c">! exnf = (presf/pref0)**(rd/cp)  !exner functions not in restart files</span>
<span class="w">            </span><span class="c">! anymore.. or at least not read</span>
<span class="w">            </span><span class="c">! exnh = (presh/pref0)**(rd/cp)</span>

<span class="w">            </span><span class="c">!   write(*,*) &quot;exnf&quot;,enf</span>
<span class="w">            </span><span class="c">!   write(*,*) &quot;exnh&quot;,exnh</span>

<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">               </span><span class="c">!write(*,*) &quot;thl0h&quot;,thl0h(i,j,k)</span>
<span class="w">               </span><span class="n">thv0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">            end do</span>

<span class="k">            do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">               </span><span class="n">thv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                               </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">            end do</span>

<span class="k">            </span><span class="n">thvh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="c">! call slabsum(thvh,kb,ke,thv0h,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke) ! redefine halflevel thv using calculated thv</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIw</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIws</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! thvh = thvh/rslabs</span>

<span class="w">            </span><span class="n">thvf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(thvf,kb,ke,thv0,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke)</span>
<span class="w">            </span><span class="c">! thvf = thvf/rslabs</span>

<span class="w">            </span><span class="c">! Set average inlet profile to initial inlet profile in case of inletgenerator mode</span>
<span class="w">            </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">uaveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">uaverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">waverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">taveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">taverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaveragei</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverager</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">waverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="n">uaveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaveragei</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! this gives the j-averaged u-velocity at the inlet</span>
<span class="w">               </span><span class="n">uaverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverager</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! this gives the j-averaged u-velocity at the recycle plane</span>
<span class="w">               </span><span class="n">waverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged w-velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">taveragei</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">thl0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">taverager</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">thl0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">taveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the j-averaged temperature at the inlet</span>
<span class="w">                  </span><span class="n">taverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taverager</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! this gives the j-averaged temperature at the recycle plane</span>
<span class="w">               </span><span class="k">end if</span>
<span class="k">               if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">lreadminl</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uaverage(kb)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uaverage(ke)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;waverage(ke)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">waverage</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;waverage(ke-20)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">waverage</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;taveragei(kb)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">taveragei</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;taveragei(ke)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">taveragei</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end if</span>

<span class="k">                  </span><span class="n">Utav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                  </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">                     </span><span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span>
<span class="w">                  </span><span class="k">end do</span>

<span class="k">                  </span><span class="n">Uinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean u-profile read from means</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Uinl(kb+10)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">                  </span><span class="n">utaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)))</span><span class="w"> </span><span class="c">! average streamwise friction at inlet (need for first time step)</span>
<span class="w">                  </span><span class="n">Urec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean u-profile</span>

<span class="w">                  </span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean w-profile</span>
<span class="w">                  </span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to zero</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">Ttav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                     </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">                        </span><span class="n">Ttav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span><span class="p">(:)</span>
<span class="w">                     </span><span class="k">end do</span>
<span class="k">                     </span><span class="n">Tinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span>
<span class="w">                     </span><span class="n">Trec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span>
<span class="w">                     </span><span class="n">ttaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">Tinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">utaui</span><span class="p">)</span><span class="w"> </span><span class="c">! friction temp. at inlet (need at first time step)</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">               else</span><span class="w"> </span><span class="c">! -&gt; lreadminl -&gt; Uinl, Urec, Wrec already read</span>
<span class="w">                  </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>

<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">                  </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">vminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">u0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">v0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">u0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">v0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>

<span class="k">               do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">                  </span><span class="n">wminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">w0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">w0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>

<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">                     </span><span class="n">tminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                     </span><span class="n">t0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                     </span><span class="n">t0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="k">                  end do</span>
<span class="k">               end if</span>

<span class="k">               write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uminletbc(jb,kb),um(ib,jb,kb)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">),</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">)</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uminletbc(jb+1,kb+10),um(ib,jb+1,kb+10)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uminletbc(je,kb+10),um(ib,je,kb+10)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               </span><span class="n">nfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nfile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Loading inletfile&#39;</span>
<span class="w">               </span><span class="k">call </span><span class="n">readinletfile</span>
<span class="w">               </span><span class="n">u0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">uminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">vminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">wminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">t0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storet0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">                  </span><span class="n">tminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storet0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="k">end if</span>
<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>

<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! idriver</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibrank</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">lchunkread</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                      call </span><span class="n">readdriverfile_chunk</span>
<span class="w">                  </span><span class="k">else</span>
<span class="k">                     call </span><span class="n">readdriverfile</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  call </span><span class="n">drivergen</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">              </span><span class="c">!call slabsum(uaverage,kb,ke,u0,ib-1,ie+1,jb-1,je+1,kb-1,ke+1,ib,ie,jb,je,kb,ke)</span>
<span class="w">              </span><span class="c">!uaverage = uaverage / ((ie-ib+1)*(jge-jgb+1))  ! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">              </span><span class="c">! call avexy_ibm(uaverage(kb:ke),u0(ib:ie,jb:je,kb:ke),ib,ie,jb,je,kb,ke,ih,jh,kh,IIu(ib:ie,jb:je,kb:ke),IIus(kb:ke),.false.)</span>
<span class="w">              </span><span class="c">! do k=kb,ke</span>
<span class="w">              </span><span class="c">!   uaverage(k) = uaverage(k)*dzf(k)</span>
<span class="w">              </span><span class="c">! end do</span>
<span class="w">              </span><span class="c">! ubulk = sum(uaverage(kb:ke))/(zh(ke+1)-zh(kb)) !volume-averaged u-velocity</span>
<span class="w">              </span><span class="c">! if (myid==0) then</span>
<span class="w">              </span><span class="c">!    write(6,*) &#39;Modstartup: ubulk=&#39;,ubulk</span>
<span class="w">              </span><span class="c">! end if</span>

<span class="w">            </span><span class="k">end if</span><span class="w"> </span><span class="c">! iinletgen/idriver</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lper2inout</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! if the restart starts from a periodic simulation to in/outflow, lper2inout should be set to .true.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;per2inout=.true. -&gt; reading inlet profile from prof.inp.XXX and scalar.inp.XXX&#39;</span>
<span class="w">                  </span><span class="k">open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span><span class="w"> </span><span class="c">!  read the inlet profile from prof.inp</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">                  </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="k">                  </span><span class="n">svprof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                     </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                        </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                     </span><span class="k">end do</span>
<span class="k">                     open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;height   sv(1) --------- sv(nsv) &#39;</span>
<span class="w">                     </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">                        </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                     </span><span class="k">end do</span>

<span class="k">                  end if</span>
<span class="k">               end if</span><span class="w"> </span><span class="c">! end if myid==0</span>

<span class="w">               </span><span class="c">! MPI broadcast numbers reading</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span><span class="o">*</span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">linoutflow</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! restart of inoutflow simulation: reproduce inlet boundary condition from restartfile</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                     </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                     </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e120</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="k">do </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span>
<span class="w">                        </span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="k">enddo</span>
<span class="k">                  enddo</span>
<span class="k">               enddo</span>
<span class="w">               </span><span class="c">! outlet bulk velocity</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="c">! else per2per... read svprof regardless...</span>

<span class="w">            </span><span class="c">! tg3315 read svprof (but do not use regardless of above...)</span>
<span class="w">              </span><span class="n">svprof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                 if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                    </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                    </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                    </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                       </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end do</span>
<span class="k">                    open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                    </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;height   sv(1) --------- sv(nsv) &#39;</span>
<span class="w">                    </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">                       </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end do</span>

<span class="k">                 end if</span>
<span class="k">              end if</span><span class="w"> </span><span class="c">! end if myid==0</span>

<span class="w">              </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span><span class="o">*</span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">!tg3315 set these variables here for now and repeat for warmstart</span>

<span class="w">                </span><span class="k">allocate</span><span class="p">(</span><span class="n">sv_top</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">))</span>
<span class="w">                </span><span class="n">sv_top</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">)</span>

<span class="w">                </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">sv_top</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">              </span><span class="k">end if</span>

<span class="k">            end if</span><span class="w"> </span><span class="c">! end if lper2inout</span>

<span class="w">            </span><span class="n">u0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">v0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">thl0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">qt0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">th0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">sv0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>

<span class="w">            </span><span class="c">! call slabsum(u0av  ,kb,ke+kh,u0(:,:,kb:ke+kh)  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">u0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIus</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(v0av  ,kb,ke+kh,v0(:,:,kb:ke+kh)  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">v0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIvs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(thl0av,kb,ke+kh,thl0(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thl0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(qt0av,kb,ke+kh,qt0(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">do </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span>
<span class="w">               </span><span class="c">! call slabsum(sv0av(kb,n),kb,ke+kh,sv0(ib-ih,jb-jh,kb,n),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">               </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">sv0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">end do</span>

<span class="w">            </span><span class="c">! CvH - only do this for fixed timestepping. In adaptive dt comes from restartfile</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">ladaptive</span><span class="p">)</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtmax</span>
<span class="w">            </span><span class="c">!  call boundary</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lEB</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">lfacTlyrs</span><span class="w"> </span><span class="p">.</span><span class="n">eqv</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.))</span><span class="w"> </span><span class="k">then</span>
<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Warmstarting an EB simulation - consider setting internal facet temperatures&quot;</span>
<span class="w">            </span><span class="k">end if</span>
<span class="k">         end if</span><span class="w"> </span><span class="c">! lwarmstart</span>
<span class="w">      </span><span class="k">end if</span><span class="w"> </span><span class="c">! not lstratstart</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">      </span><span class="c">!    2.1 read and initialise fields</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;lscale.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">         </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">         </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">         </span><span class="c">! write (6, *) &#39; height  u_geo  v_geo  pgx  pgy  subs     &#39; &amp;</span>
<span class="w">         </span><span class="c">!    , &#39;   dqtdx      dqtdy        dqtdtls     thl_rad &#39;</span>
<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">ug</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">vg</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">pgx</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">pgy</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">wfls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">dqtdxls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">dqtdyls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">dqtdtls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">thlpcar</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">         close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">         </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">         </span><span class="c">!    write (6, &#39;(3f7.1,5e12.4)&#39;) &amp;</span>
<span class="w">         </span><span class="c">!       height(k), &amp;</span>
<span class="w">         </span><span class="c">!       ug(k), &amp;</span>
<span class="w">         </span><span class="c">!       vg(k), &amp;</span>
<span class="w">         </span><span class="c">!       pgx(k), &amp;</span>
<span class="w">         </span><span class="c">!       pgy(k), &amp;</span>
<span class="w">         </span><span class="c">!       wfls(k), &amp;</span>
<span class="w">         </span><span class="c">!       dqtdxls(k), &amp;</span>
<span class="w">         </span><span class="c">!       dqtdyls(k), &amp;</span>
<span class="w">         </span><span class="c">!       dqtdtls(k), &amp;</span>
<span class="w">         </span><span class="c">!       thlpcar(k)</span>
<span class="w">         </span><span class="c">! end do</span>

<span class="w">      </span><span class="k">end if</span><span class="w"> </span><span class="c">! end myid==0</span>

<span class="w">      </span><span class="c">! MPI broadcast variables read in</span>

<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">ug</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">pgx</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">pgy</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">wfls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dqtdxls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dqtdyls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dqtdtls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlpcar</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">      </span><span class="c">!    2.3 make large-scale horizontal pressure gradient</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">      </span><span class="c">!******include rho if rho = rho(z) /= 1.0 ***********</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lprofforc</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">!tg3315</span>
<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="n">dpdxl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pgx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dpdx</span><span class="w"> </span><span class="c">!-om23_gs*ug(k)-pgx(k)-dpdx</span>
<span class="w">            </span><span class="n">dpdyl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pgy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">      else</span>
<span class="k">         do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="c">!dpdxl(k) =  om23_gs*vg(k)</span>
<span class="w">            </span><span class="c">!dpdyl(k) = -om23_gs*ug(k)</span>
<span class="w">            </span><span class="c">!dpdxl(k) =  -ug(k)</span>
<span class="w">            </span><span class="c">!dpdyl(k) =  -vg(k)</span>
<span class="w">            </span><span class="n">dpdxl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">om23_gs</span><span class="o">*</span><span class="n">vg</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pgx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dpdx</span><span class="w"> </span><span class="c">!corriolis forcing and pressure gradient</span>
<span class="w">            </span><span class="n">dpdyl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">om23_gs</span><span class="o">*</span><span class="n">ug</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pgy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">      endif</span>

<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">      </span><span class="c">!    2.4 large-scale subsidence, reintroduced ILS13 05.06.2014</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">      </span><span class="n">whls</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">      </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">         </span><span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wfls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wfls</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      </span><span class="n">whls</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wfls</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wfls</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wfls</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="c">! tg3315 31/07/18 removed a 0.5</span>

<span class="w">      </span><span class="c">!    idtmax = floor(dtmax/tres)</span>
<span class="w">      </span><span class="n">btime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timee</span>
<span class="w">      </span><span class="c">!    timeleft=ceiling(runtime/tres)</span>
<span class="w">      </span><span class="n">timeleft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runtime</span>
<span class="w">      </span><span class="n">dt_lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeleft</span>
<span class="w">      </span><span class="c">!    write(6,*) &#39;real(dt)*tres= &#39;,rdt, &#39; dtmax/100= &#39;,dtmax/100</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">lwarmstart</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">lstratstart</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! tg3315 to have cumulative number on restart files</span>
<span class="w">         </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">startfile</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">13</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;(i8)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ntrun</span>
<span class="w">         </span><span class="c">! ntrun = ichar(startfile(6:13))</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">         </span><span class="n">ntrun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">      </span><span class="n">ntimee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">nint</span><span class="p">(</span><span class="n">timee</span><span class="o">/</span><span class="n">dtmax</span><span class="p">)</span>
<span class="w">      </span><span class="n">tnextrestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trestart</span>
<span class="w">      </span><span class="n">tnextfielddump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tfielddump</span>
<span class="w">      </span><span class="n">tEB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span>
<span class="w">      </span><span class="n">tnextEB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dtEB</span>
<span class="w">      </span><span class="n">tfac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span>
<span class="w">      </span><span class="n">tnextfac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dtfac</span>
<span class="w">      </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">th0av</span><span class="p">)</span>

<span class="w">      </span><span class="c">!    call boundary</span>

<span class="w">   </span><span class="k">end subroutine </span><span class="n">readinitfiles</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              uDALES
 was developed by The uDALES Team<br>              &copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
 on 2024-08-29 16:19              </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>